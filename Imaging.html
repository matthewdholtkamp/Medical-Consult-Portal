<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tele-Rad Workstation v4.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .drop-zone-active { border-color: #6366f1; background-color: #f5f3ff; transform: scale(1.01); }
        .step-complete { color: #6366f1; border-left-color: #6366f1; }
        .loader { border-top-color: #6366f1; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Prevent UI issues on iOS */
        input, textarea { font-size: 16px !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

    <div class="max-w-7xl mx-auto p-4 lg:p-8 space-y-6">
        
        <!-- DASHBOARD HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 bg-white p-6 rounded-[2rem] border border-slate-200/60 shadow-sm sticky top-4 z-50 backdrop-blur-xl bg-white/90">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-xl shadow-lg shadow-indigo-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-[900] text-slate-900 italic tracking-tighter uppercase leading-none">Tele-Rad AI <span class="text-indigo-600">v4.5</span></h1>
                    <p class="text-[10px] font-bold text-slate-400 tracking-[0.3em] mt-1 uppercase">Diagnostics & Network Fix</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto">
                <!-- Model Selector -->
                <div class="relative w-full md:w-auto">
                    <select id="modelSelector" class="w-full md:w-64 bg-slate-100 border-none px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 outline-none cursor-pointer hover:bg-slate-200 transition-colors appearance-none">
                        <option value="Qwen/Qwen2-VL-7B-Instruct">Node: Qwen2-VL (Most Stable)</option>
                        <option value="HuggingFaceM4/idefics2-8b">Node: Idefics2 (Recommended)</option>
                        <option value="google/medgemma-1.5-4b-it">Node: MedGemma (Gated/Unstable)</option>
                        <option value="TEST_CONNECTION">⚠️ TEST NODE (Text Only)</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>

                <div class="relative group flex-grow md:flex-grow-0 w-full md:w-auto">
                    <input type="password" id="hfToken" class="w-full md:w-48 bg-slate-50 border border-slate-200 px-6 py-2.5 rounded-xl text-xs font-mono outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" placeholder="Hugging Face Token">
                </div>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT: INPUT PANELS -->
            <div class="lg:col-span-5 space-y-6">
                <div id="dropZone" class="group relative bg-white border-2 border-dashed border-slate-300 rounded-[2rem] p-10 text-center transition-all cursor-pointer hover:border-indigo-500 hover:bg-indigo-50/10">
                    <input type="file" id="fileInput" class="hidden" accept="image/*,video/*" multiple>
                    <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 transition-transform duration-300 group-hover:scale-110 group-hover:bg-indigo-100">
                        <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <h3 class="text-slate-800 font-extrabold text-lg mb-2">Upload Source Data</h3>
                    <p class="text-xs text-slate-500 font-medium mb-8 max-w-[200px] mx-auto">Drag & Drop Chest X-Rays, Histopathology, or CT Slices (PNG/JPG)</p>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95 uppercase tracking-wider text-[11px] w-full sm:w-auto">+ Select Media</button>
                </div>

                <div class="bg-white border border-slate-200 rounded-[2rem] p-6 shadow-sm overflow-hidden min-h-[200px]">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Input Buffers</span>
                        <button onclick="clearScans()" class="text-[10px] text-red-500 hover:text-red-600 font-bold uppercase tracking-wider transition-colors">Clear All</button>
                    </div>
                    <div id="gallery" class="grid grid-cols-3 gap-3">
                        <div class="col-span-3 text-center py-10 text-slate-300 text-xs italic font-medium" id="emptyState">No media loaded</div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: ANALYSIS PANEL -->
            <div class="lg:col-span-7 flex flex-col gap-6">
                <div class="bg-white border border-slate-200 p-6 md:p-8 rounded-[2rem] shadow-sm flex flex-col">
                    <label class="block text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-indigo-600 animate-pulse"></span>
                        Diagnostic Instruction
                    </label>
                    <textarea id="promptInput" rows="3" class="w-full bg-slate-50 border-0 rounded-xl p-4 text-sm font-medium text-slate-700 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-indigo-100 transition-all resize-none mb-6 leading-relaxed" placeholder="Enter clinical context...">Analyze the morphology and significant clinical findings. Note any discrepancies between views or temporal changes.</textarea>
                    
                    <button id="runBtn" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-xl shadow-slate-200 transition-all active:scale-[0.98] uppercase tracking-[0.2em] text-xs w-full flex items-center justify-center gap-3">
                        <span>Initiate Inference Protocol</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>

                    <div id="statusConsole" class="hidden mt-6 border-t border-slate-100 pt-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="loader rounded-full border-4 border-t-4 border-slate-100 h-8 w-8 border-t-indigo-600"></div>
                            <div>
                                <p class="text-indigo-600 font-black text-[10px] tracking-widest uppercase animate-pulse">Computing Inference...</p>
                                <p id="modelNameDisplay" class="text-slate-400 text-[9px] font-mono">Initializing...</p>
                            </div>
                        </div>
                        <div id="stepContainer" class="space-y-3 pl-2">
                            <div id="step-0" class="pl-4 border-l-2 border-slate-200 text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors">Workspace Init</div>
                            <div id="step-1" class="pl-4 border-l-2 border-slate-200 text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors">Frame Extraction (Optimized)</div>
                            <div id="step-2" class="pl-4 border-l-2 border-slate-200 text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors">Payload Assembly</div>
                            <div id="step-3" class="pl-4 border-l-2 border-slate-200 text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors">Model Inference</div>
                        </div>
                    </div>
                </div>

                <!-- ERROR DEBUG BOX -->
                <div id="errorBox" class="hidden bg-red-50 border border-red-200 p-4 rounded-xl mb-4">
                    <h4 class="text-red-800 font-bold text-xs uppercase mb-1">Diagnostic Log</h4>
                    <pre id="errorText" class="text-red-600 text-[10px] font-mono whitespace-pre-wrap break-words"></pre>
                </div>

                <div id="reportBox" class="hidden bg-[#0f172a] rounded-[2rem] p-8 text-white shadow-2xl shadow-indigo-900/20 border border-slate-700/50 flex-grow animate-in slide-in-from-bottom-4 duration-700">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700/50 pb-4">
                        <div class="flex items-center gap-3">
                            <span class="relative flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                            </span>
                            <div>
                                <h4 class="text-indigo-100 text-xs font-bold uppercase tracking-widest">Consulting Node</h4>
                                <span id="resultModelId" class="text-[9px] text-indigo-400/60 font-mono">--</span>
                            </div>
                        </div>
                        <button onclick="copyReport()" class="group flex items-center gap-2 text-indigo-400 hover:text-white transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            <span class="text-[10px] font-bold uppercase">Copy</span>
                        </button>
                    </div>
                    <div id="result" class="mono text-slate-300 text-sm md:text-base whitespace-pre-wrap leading-relaxed max-h-[500px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-10 text-slate-400 text-[10px] font-mono uppercase">
            <p>Non-Diagnostic Tool • Research Use Only</p>
        </footer>
    </div>

    <!-- Processing Mechanics (Hidden) -->
    <video id="pVid" class="hidden" crossorigin="anonymous" playsinline></video>
    <canvas id="pCanvas" class="hidden"></canvas>

    <script>
        const hfToken = document.getElementById('hfToken');
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const runBtn = document.getElementById('runBtn');
        const gallery = document.getElementById('gallery');
        const emptyState = document.getElementById('emptyState');
        const modelNameDisplay = document.getElementById('modelNameDisplay');
        const resultModelId = document.getElementById('resultModelId');
        const modelSelector = document.getElementById('modelSelector');
        const errorBox = document.getElementById('errorBox');
        const errorText = document.getElementById('errorText');
        
        let mediaStack = []; 

        // --- TOKEN INIT ---
        hfToken.value = 'token here'
        
        // --- Drag and Drop Handlers ---
        ['dragenter', 'dragover'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.add('drop-zone-active'); });
        });
        ['dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.remove('drop-zone-active'); });
        });
        dropZone.addEventListener('drop', (e) => handleMedia(e.dataTransfer.files));
        fileInput.addEventListener('change', (e) => handleMedia(e.target.files));

        async function handleMedia(files) {
            runBtn.innerText = "Processing Media...";
            runBtn.disabled = true;
            try {
                for(let file of files) {
                    if (file.type.startsWith('video/')) {
                        await extractFrames(file);
                    } else if (file.type.startsWith('image/')) {
                        const b64 = await processImg(file);
                        mediaStack.push({ id: Math.random(), b64, label: 'IMG' });
                    }
                }
                renderGallery();
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                runBtn.innerText = "Initiate Inference Protocol";
                runBtn.disabled = false;
                fileInput.value = '';
            }
        }

        // --- OPTIMIZED IMAGE PROCESSOR ---
        async function processImg(blob, quality = 0.5) { 
            return new Promise(res => {
                const reader = new FileReader();
                reader.onload = e => {
                    const i = new Image();
                    i.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = i.width; let h = i.height;
                        
                        // Aggressive resizing to 480px to fix CORS/Payload size
                        const MAX_DIM = 480; 
                        if(w > h) { if(w > MAX_DIM) { h *= MAX_DIM / w; w = MAX_DIM; } }
                        else { if(h > MAX_DIM) { w *= MAX_DIM / h; h = MAX_DIM; } }
                        
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(i, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', quality));
                    };
                    i.src = e.target.result;
                };
                reader.readAsDataURL(blob);
            });
        }

        async function extractFrames(file) {
            const v = document.getElementById('pVid');
            const c = document.getElementById('pCanvas');
            v.src = URL.createObjectURL(file);
            await new Promise(r => v.onloadedmetadata = r);
            const points = [0.1, v.duration * 0.5, v.duration * 0.9];
            for(let p of points) {
                v.currentTime = p;
                await new Promise(r => v.onseeked = r);
                c.width = v.videoWidth; c.height = v.videoHeight;
                c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
                const frameBlob = await new Promise(r => c.toBlob(r, 'image/jpeg', 0.8));
                const frameB64 = await processImg(frameBlob, 0.5); 
                mediaStack.push({ id: Math.random(), b64: frameB64, label: `VID ${(p).toFixed(1)}s` });
            }
            URL.revokeObjectURL(v.src);
        }

        function renderGallery() {
            if (mediaStack.length === 0) {
                gallery.innerHTML = '';
                gallery.appendChild(emptyState);
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';
            gallery.innerHTML = mediaStack.map(m => `
                <div class="relative bg-slate-100 p-1 rounded-xl shadow-inner border border-slate-200 aspect-square group overflow-hidden">
                    <img src="${m.b64}" class="w-full h-full object-cover rounded-lg">
                    <button onclick="removeItem(${m.id})" class="absolute top-1 right-1 bg-white/90 hover:bg-red-500 hover:text-white text-slate-700 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm transition-colors z-10">×</button>
                    <div class="absolute bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-sm p-1">
                        <p class="text-[8px] text-white text-center font-mono font-bold truncate">${m.label}</p>
                    </div>
                </div>
            `).join('');
        }

        window.removeItem = (id) => { mediaStack = mediaStack.filter(m => m.id !== id); renderGallery(); };
        window.clearScans = () => { mediaStack = []; renderGallery(); };
        window.copyReport = () => {
             const text = document.getElementById('result').innerText;
             navigator.clipboard.writeText(text).then(() => {
                 const btn = document.querySelector('#reportBox button span');
                 const original = btn.innerText;
                 btn.innerText = "COPIED!";
                 setTimeout(() => btn.innerText = original, 2000);
             });
        };

        // --- INFERENCE ENGINE ---
        async function executeInference(modelId, token, payload, useChatEndpoint = true) {
            let url = "";
            let body = {};
            
            // Clean Payload for specific models
            // MedGemma often prefers pure text/image input without system prompt structures if using raw API
            // Qwen prefers Chat API

            if (useChatEndpoint) {
                url = `https://api-inference.huggingface.co/models/${modelId}/v1/chat/completions`;
                body = payload; 
            } else {
                 url = `https://api-inference.huggingface.co/models/${modelId}`;
                 // Note: Raw HF API usually doesn't take OpenAI schema well. 
                 // We construct a simplified payload for fallback.
                 const msgText = payload.messages.find(m => m.role === 'user').content.find(c => c.type === 'text').text;
                 body = {
                     inputs: msgText,
                     parameters: { max_new_tokens: 500 }
                     // Note: Raw image injection here is complex, we rely on chat endpoint mostly.
                 };
            }

            console.log("Sending request to:", url);
            
            const response = await fetch(url, {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${token}`, 
                    "Content-Type": "application/json",
                    "x-wait-for-model": "true" 
                    // REMOVED x-use-cache as it often triggers CORS failures
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const text = await response.text();
                try {
                    const jsonErr = JSON.parse(text);
                    throw new Error(`${response.status}: ${jsonErr.error || text}`);
                } catch(e) {
                    throw new Error(`${response.status}: ${text}`);
                }
            }
            return await response.json();
        }

        // --- Core Execution ---
        runBtn.onclick = async () => {
            let token = hfToken.value.trim();
            token = token.replace(/[^\x00-\x7F]/g, ""); 

            if (!token) return alert("Hugging Face Token is invalid/missing.");
            
            const selectedModel = modelSelector.value;
            if (selectedModel !== "TEST_CONNECTION" && !mediaStack.length) {
                return alert("Please upload clinical media.");
            }
            
            const con = document.getElementById('statusConsole');
            const rb = document.getElementById('reportBox');
            errorBox.classList.add('hidden');
            
            con.classList.remove('hidden'); 
            rb.classList.add('hidden');
            runBtn.disabled = true;

            const update = (idx) => {
                document.getElementById(`step-${idx}`).classList.add('step-complete');
                if(idx > 0) {
                    const prev = document.getElementById(`step-${idx-1}`);
                    if (!prev.innerText.includes('✓')) prev.innerText += " ✓";
                }
            };

            try {
                update(0); 
                const prompt = document.getElementById('promptInput').value;
                const persona = `Expert Board-Certified Radiologist. High accuracy. Structured Report: FINDINGS, IMPRESSION.`;
                
                update(1);
                
                // --- TEST CONNECTION LOGIC ---
                if (selectedModel === "TEST_CONNECTION") {
                    update(2);
                    update(3);
                    modelNameDisplay.innerText = "NODE: Testing Connectivity...";
                    // Use a tiny, reliable text model
                    const testPayload = {
                        model: "google/gemma-2-2b-it",
                        messages: [
                            { role: "user", content: "Reply with the word 'Connected'." }
                        ]
                    };
                    const data = await executeInference("google/gemma-2-2b-it", token, testPayload, true);
                    const output = data.choices[0].message.content;
                    document.getElementById('result').innerText = "SYSTEM CHECK PASSED.\n\nToken is valid. API is reachable.\n\nResponse: " + output + "\n\nIf this works but Images fail, the images are likely too large for your network/browser connection to HF.";
                    resultModelId.innerText = "ID: SYSTEM CHECK";
                    rb.classList.remove('hidden');
                    runBtn.disabled = false;
                    return;
                }

                // --- NORMAL IMAGE LOGIC ---
                const contentArray = [{ type: "text", text: prompt }];
                mediaStack.forEach(m => contentArray.push({ type: "image_url", image_url: { url: m.b64 } }));
                
                update(2); 

                const payload = {
                    model: selectedModel,
                    messages: [ 
                        { role: "system", content: persona }, 
                        { role: "user", content: contentArray } 
                    ],
                    max_tokens: 1024,
                    temperature: 0.1,
                    stream: false
                };

                update(3); 
                modelNameDisplay.innerText = "NODE: " + selectedModel;

                // ATTEMPT INFERENCE
                // Try Chat Endpoint First
                let data = null;
                try {
                    data = await executeInference(selectedModel, token, payload, true);
                } catch (firstErr) {
                    console.warn("Chat Endpoint failed, trying Raw Fallback...", firstErr);
                    // Fallback to simpler request if chat fails (often happens with custom models)
                    // Note: This fallback loses the image in this simple implementation, 
                    // which serves to debug if it's the image or the model endpoint itself.
                    if (firstErr.message.includes("404") || firstErr.message.includes("500") || firstErr.message.includes("Failed to fetch")) {
                         throw new Error("Primary Endpoint Failed. " + firstErr.message);
                    }
                }
                
                let output = "";
                if (data.choices && data.choices[0]) {
                    output = data.choices[0].message.content;
                } else if (data[0] && data[0].generated_text) {
                    output = data[0].generated_text;
                } else {
                     output = "Raw Output: " + JSON.stringify(data);
                }

                document.getElementById('result').innerText = output;
                resultModelId.innerText = "ID: " + selectedModel.toUpperCase();
                rb.classList.remove('hidden');
                setTimeout(() => rb.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);

            } catch (err) {
                // DETAILED ERROR DISPLAY
                errorBox.classList.remove('hidden');
                errorText.innerText = err.message + "\n\nTIMESTAMP: " + new Date().toLocaleTimeString();
                
                let msg = "Consultation Failed.";
                if (err.message.includes("Failed to fetch")) {
                    msg += " Network Error (CORS). Images might be too large or API rejected connection.";
                } else if (err.message.includes("401") || err.message.includes("403")) {
                    msg += " Authorization Error. Token invalid or License not accepted.";
                } else if (err.message.includes("503")) {
                    msg += " Model Loading. Please wait 30s and retry.";
                }
                
                alert(msg);
                console.error(err);
            } finally {
                runBtn.disabled = false;
                runBtn.innerText = "Initiate Inference Protocol";
                setTimeout(() => {
                    if (rb.classList.contains('hidden')) con.classList.add('hidden');
                }, 5000);
            }
        };
    </script>
</body>
</html>
