<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ICU Critical Care Consultant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/theme.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .hidden { display: none !important; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px; height: 36px;
            border-radius: 50%;
            border-left-color: #f43f5e; /* Rose-500 for ICU/Critical */
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { cursor: pointer; }
        
        .error-box { 
            display: none; 
            background-color: rgba(127, 29, 29, 0.5); 
            border: 1px solid #dc2626; 
            color: #fca5a5; 
            padding: 1rem; 
            border-radius: 0.375rem; 
            margin-bottom: 1rem; 
        }
        .error-box.active { display: block; }
        
        .note-preview::-webkit-scrollbar { width: 8px; }
        .note-preview::-webkit-scrollbar-track { background: #1f2937; }
        .note-preview::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        /* ICU Gradient Text */
        .text-gradient-icu {
            background: linear-gradient(to right, #fb7185, #e11d48);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #e11d48;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #e11d48;
        }
    </style>
</head>
<body class="bg-gemini-900 text-gray-200 font-sans">

    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        
        <header class="text-center mb-8 border-b border-slate-800 pb-6">
            <div class="flex justify-center items-center mb-2">
                <i class="fa-solid fa-heart-pulse text-rose-500 text-4xl mr-3"></i>
                <h1 class="text-4xl font-bold text-white tracking-wider">AI CRITICAL <span class="text-gradient-icu">CARE</span></h1>
            </div>
            <p class="text-lg text-slate-400">Systems-Based Decision Support & Workflow Automation</p>
        </header>

        <!-- HIPAA WARNING -->
        <details class="bg-slate-900 border border-slate-700 rounded-md mb-8 shadow-lg">
            <summary class="font-semibold text-slate-300 p-4 cursor-pointer text-lg flex justify-between items-center hover:bg-slate-800 transition">
                <span class="flex items-center"><i class="fa-solid fa-user-shield mr-2 text-rose-500"></i> SECURITY & COMPLIANCE</span>
                <span class="text-xs bg-rose-900/80 text-rose-100 px-2 py-1 rounded border border-rose-500">HIPAA Safe Harbor Required</span>
            </summary>
            <div class="p-4 border-t border-slate-700 text-sm bg-slate-950/50">
                <p class="font-bold text-rose-400 mb-3">STRICTLY PROHIBITED: THE 18 HIPAA IDENTIFIERS</p>
                <p class="text-slate-400 mb-2 italic">Do not enter any of the following data points:</p>
                <ul class="list-disc ml-5 space-y-1 text-slate-400 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 text-xs">
                    <li>Names</li>
                    <li>Geographic subdivisions smaller than state</li>
                    <li>All elements of dates (except year)</li>
                    <li>Telephone numbers</li>
                    <li>Fax numbers</li>
                    <li>Email addresses</li>
                    <li>Social Security numbers</li>
                    <li>Medical Record numbers</li>
                    <li>Health plan beneficiary numbers</li>
                    <li>Account numbers</li>
                    <li>Certificate/license numbers</li>
                    <li>Vehicle identifiers/serial numbers</li>
                    <li>Device identifiers/serial numbers</li>
                    <li>Web URLs</li>
                    <li>IP address numbers</li>
                    <li>Biometric identifiers (finger/voice)</li>
                    <li>Full face photographic images</li>
                    <li>Any other unique identifying number</li>
                </ul>
            </div>
        </details>

        <!-- LOADING SPINNER -->
        <div id="loading-spinner" class="hidden flex flex-col justify-center items-center p-12">
            <div class="spinner mb-4"></div>
            <p class="text-xl font-semibold text-slate-300 animate-pulse" id="loading-text">Processing Clinical Data...</p>
        </div>

        <!-- SECTION 1: INTAKE -->
        <div id="section-intake" class="bg-slate-900 p-6 rounded-lg shadow-xl border-t-4 border-rose-600">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-white flex items-center mb-4 md:mb-0">
                    <span class="bg-rose-700 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                    Consult Configuration
                </h2>

                <!-- TYPE TOGGLE -->
                <div class="bg-slate-800 p-1 rounded-lg flex border border-slate-700">
                    <button type="button" id="btn-initial" class="px-6 py-2 rounded-md text-sm font-bold transition-all bg-rose-600 text-white shadow">Initial Consult</button>
                    <button type="button" id="btn-followup" class="px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-white">Follow-up Note</button>
                </div>
            </div>

            <div id="error-message-intake" class="error-box hidden"></div>
            
            <form id="intake-form">
                
                <!-- Core Demographics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-slate-950 p-4 rounded-lg border border-slate-800">
                      <div class="md:col-span-1">
                         <label class="block text-xs font-bold text-rose-400 mb-2 uppercase tracking-wide">
                             <i class="fa-solid fa-hashtag mr-1"></i> Age / Sex
                         </label>
                         <input type="text" id="age-input" class="w-full p-3 border border-slate-700 rounded bg-slate-900 text-white focus:ring-2 focus:ring-rose-500 outline-none" placeholder="e.g. 65yo M">
                      </div>
                      <div class="md:col-span-1">
                         <label class="block text-xs font-bold text-rose-400 mb-2 uppercase tracking-wide">
                             <i class="fa-solid fa-hospital-user mr-1"></i> Location
                          </label>
                          <select id="location-input" class="w-full p-3 border border-slate-700 rounded bg-slate-900 text-white focus:ring-2 focus:ring-rose-500 outline-none">
                             <option value="ICU">Inpatient ICU</option>
                             <option value="Inpatient Ward">Inpatient Ward</option>
                             <option value="ER">Emergency Room (ER)</option>
                          </select>
                      </div>
                      <div class="md:col-span-1">
                         <label class="block text-xs font-bold text-rose-400 mb-2 uppercase tracking-wide">
                             <i class="fa-solid fa-bed-pulse mr-1"></i> Code Status
                         </label>
                         <select id="code-status" class="w-full p-3 border border-slate-700 rounded bg-slate-900 text-white focus:ring-2 focus:ring-rose-500 outline-none">
                            <option value="Full Code">Full Code</option>
                            <option value="DNR/DNI">DNR / DNI</option>
                            <option value="DNR/Ok to Intubate">DNR / OK to Intubate</option>
                        </select>
                      </div>
                </div>

                <!-- DYNAMIC CONTENT AREA -->
                
                <!-- SCENARIO A: INITIAL CONSULT -->
                <div id="initial-fields" class="block space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-white mb-1">Reason for Consult / HPI:</label>
                        <textarea id="hpi-input" rows="3" class="w-full p-3 border border-slate-700 rounded-md focus:ring-2 focus:ring-rose-500 focus:outline-none bg-slate-800 text-white placeholder-slate-500" placeholder="e.g., Acute respiratory failure, septic shock etiology unclear..."></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="load-example-btn" class="text-xs text-rose-400 hover:text-rose-300 underline">Load Sepsis Case</button>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-white mb-1">Past Medical History:</label>
                        <textarea id="pmh-input" rows="2" class="w-full p-3 border border-slate-700 rounded-md focus:ring-2 focus:ring-rose-500 focus:outline-none bg-slate-800 text-white placeholder-slate-500" placeholder="e.g. COPD, CHF (EF 30%), DM2"></textarea>
                    </div>
                </div>

                <!-- SCENARIO B: FOLLOW-UP NOTE -->
                <div id="followup-fields" class="hidden space-y-4">
                    <div class="bg-indigo-900/20 border border-indigo-700/50 p-4 rounded-md">
                        <label class="block text-sm font-bold text-indigo-300 mb-2">
                            <i class="fa-solid fa-paste mr-2"></i>Paste Yesterday's Note / Current Meds
                        </label>
                        <textarea id="prior-note-input" rows="6" class="w-full p-3 border border-slate-700 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-slate-900 text-slate-300 text-xs font-mono placeholder-slate-600" placeholder="Paste the full text of the previous progress note or H&P here..."></textarea>
                    </div>
                    
                    <div class="bg-rose-900/20 border border-rose-700/50 p-4 rounded-md">
                        <label class="block text-sm font-bold text-rose-300 mb-2">
                            <i class="fa-solid fa-clock-rotate-left mr-2"></i>24-Hour / Overnight Events
                        </label>
                        <textarea id="events-input" rows="4" class="w-full p-3 border border-slate-700 rounded-md focus:ring-2 focus:ring-rose-500 focus:outline-none bg-slate-900 text-white placeholder-slate-500" placeholder="e.g. Spiked fever to 39.4 at 0200, started Vanco. Extubated at 0800. Urine output decreased."></textarea>
                    </div>
                </div>

                <!-- SHARED CLINICAL DATA -->
                <div class="mt-6 pt-6 border-t border-slate-800">
                    <h3 class="text-sm font-bold text-slate-400 mb-3 uppercase">Current Objectve Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Vitals (Current/Range)</label>
                            <input type="text" id="vitals-input" class="w-full p-2 border border-slate-700 rounded bg-slate-900 text-white text-sm" placeholder="BP 110/60 (on levo), HR 110, RR 24">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Vent/O2 Settings</label>
                            <input type="text" id="vent-input" class="w-full p-2 border border-slate-700 rounded bg-slate-900 text-white text-sm" placeholder="AC/VC 450/5/12 40% or 4L NC">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Relevant Labs</label>
                            <input type="text" id="labs-input" class="w-full p-2 border border-slate-700 rounded bg-slate-900 text-white text-sm" placeholder="WBC 18, Cr 2.1, Lactate 4.0">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Lines / Drains / Access</label>
                            <input type="text" id="lines-input" class="w-full p-2 border border-slate-700 rounded bg-slate-900 text-white text-sm" placeholder="R IJ TLC, Foley, Dobhoff">
                        </div>
                    </div>
                </div>

                <button type="submit" class="mt-8 w-full bg-gradient-to-r from-rose-700 to-red-600 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg hover:from-rose-600 hover:to-red-500 transition-all transform hover:-translate-y-1 flex items-center justify-center border border-rose-800">
                    <span class="mr-3">Initiate ICU Systems Analysis</span>
                    <i class="fa-solid fa-microscope"></i>
                </button>
            </form>
        </div>

        <!-- SECTION 2: FOLLOW-UP QUESTIONS -->
        <div id="section-questions" class="hidden bg-slate-900 p-6 rounded-lg shadow-xl border border-slate-700">
            <h2 class="text-xl font-semibold mb-4 text-white border-b border-slate-800 pb-2 flex items-center">
                <i class="fa-solid fa-user-doctor text-rose-500 mr-2"></i> Intensivist Clarification
            </h2>
            <p class="text-sm text-slate-400 mb-6 bg-slate-950 p-3 rounded border-l-4 border-rose-600">
                To complete the systems-based plan, I need a few specific data points based on the pathology.
            </p>
            <div id="error-message-questions" class="error-box hidden"></div>
            <form id="questions-form">
                <div id="questions-container" class="space-y-5 mb-8"></div>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <button type="button" id="questions-back-btn" class="flex-1 bg-slate-800 text-slate-300 font-bold py-3 rounded-lg hover:bg-slate-700 transition">Back</button>
                    <button type="submit" class="flex-[2] bg-rose-700 text-white font-bold py-3 rounded-lg hover:bg-rose-600 transition shadow-lg">Generate Systems Note</button>
                </div>
            </form>
        </div>

        <!-- SECTION 3: SYSTEMS REVIEW -->
        <div id="section-review" class="hidden space-y-6">
            
            <div class="bg-slate-900 p-6 rounded-lg border border-slate-800 shadow-xl">
                 <h2 class="text-2xl font-bold text-white mb-2 flex items-center">
                    <span class="bg-rose-600 text-white text-xs px-2 py-1 rounded mr-3 uppercase tracking-wider">Plan Review</span>
                    Systems-Based Assessment
                </h2>
                <div id="assessment-summary" class="text-slate-300 italic mb-4 bg-slate-950 p-4 rounded border-l-2 border-rose-500"></div>
                
                <!-- Systems Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- NEURO -->
                    <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden">
                        <div class="bg-slate-950 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-rose-400 uppercase text-xs">Neurology / Pain / Sedation</h3>
                            <i class="fa-solid fa-brain text-slate-600"></i>
                        </div>
                        <div class="p-4">
                            <textarea id="sys-neuro" class="w-full bg-slate-900 text-slate-300 text-sm border border-slate-700 rounded p-2 h-32 font-mono leading-tight"></textarea>
                        </div>
                    </div>

                    <!-- CV -->
                    <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden">
                        <div class="bg-slate-950 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-rose-400 uppercase text-xs">Cardiovascular</h3>
                            <i class="fa-solid fa-heart-pulse text-slate-600"></i>
                        </div>
                        <div class="p-4">
                            <textarea id="sys-cv" class="w-full bg-slate-900 text-slate-300 text-sm border border-slate-700 rounded p-2 h-32 font-mono leading-tight"></textarea>
                        </div>
                    </div>

                    <!-- RESP -->
                    <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden">
                        <div class="bg-slate-950 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-rose-400 uppercase text-xs">Respiratory</h3>
                            <i class="fa-solid fa-lungs text-slate-600"></i>
                        </div>
                        <div class="p-4">
                            <textarea id="sys-resp" class="w-full bg-slate-900 text-slate-300 text-sm border border-slate-700 rounded p-2 h-32 font-mono leading-tight"></textarea>
                        </div>
                    </div>

                    <!-- GI/GU/RENAL -->
                    <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden">
                        <div class="bg-slate-950 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-rose-400 uppercase text-xs">Renal / Fluids / GI / Endo</h3>
                            <i class="fa-solid fa-kidneys text-slate-600"></i>
                        </div>
                        <div class="p-4">
                            <textarea id="sys-renal" class="w-full bg-slate-900 text-slate-300 text-sm border border-slate-700 rounded p-2 h-32 font-mono leading-tight"></textarea>
                        </div>
                    </div>

                    <!-- HEME/ID -->
                    <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden">
                        <div class="bg-slate-950 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-rose-400 uppercase text-xs">ID / Heme / PPX</h3>
                            <i class="fa-solid fa-bacterium text-slate-600"></i>
                        </div>
                        <div class="p-4">
                            <textarea id="sys-heme" class="w-full bg-slate-900 text-slate-300 text-sm border border-slate-700 rounded p-2 h-32 font-mono leading-tight"></textarea>
                        </div>
                    </div>

                    <!-- ABCDE BUNDLE -->
                    <div class="bg-slate-800 rounded border border-rose-900/50 overflow-hidden">
                        <div class="bg-rose-950 px-4 py-2 border-b border-rose-900 flex justify-between items-center">
                            <h3 class="font-bold text-rose-300 uppercase text-xs">ABCDE Bundle</h3>
                            <i class="fa-solid fa-list-check text-rose-500"></i>
                        </div>
                        <div class="p-4 space-y-2">
                             <div class="flex items-center">
                                <input type="checkbox" id="abcde-a" checked class="mr-2 accent-rose-500 h-4 w-4">
                                <label for="abcde-a" class="text-sm text-slate-300"><b>A:</b> Awakening Trial</label>
                             </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="abcde-b" checked class="mr-2 accent-rose-500 h-4 w-4">
                                <label for="abcde-b" class="text-sm text-slate-300"><b>B:</b> Breathing Trial</label>
                             </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="abcde-c" checked class="mr-2 accent-rose-500 h-4 w-4">
                                <label for="abcde-c" class="text-sm text-slate-300"><b>C:</b> Coordination of Care / Sedation Choice</label>
                             </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="abcde-d" checked class="mr-2 accent-rose-500 h-4 w-4">
                                <label for="abcde-d" class="text-sm text-slate-300"><b>D:</b> Delirium Monitoring (CAM-ICU)</label>
                             </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="abcde-e" checked class="mr-2 accent-rose-500 h-4 w-4">
                                <label for="abcde-e" class="text-sm text-slate-300"><b>E:</b> Early Mobility</label>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button type="button" id="review-back-btn" class="flex-1 bg-slate-700 text-slate-300 font-bold py-3 rounded-lg hover:bg-slate-600">Back</button>
                <button type="button" id="review-finalize-btn" class="flex-1 bg-green-700 text-white font-bold py-3 rounded-lg hover:bg-green-600 shadow-lg">Finalize Note</button>
            </div>
        </div>

        <!-- SECTION 4: FINAL NOTE -->
        <div id="section-final" class="hidden bg-slate-900 p-6 rounded-lg shadow-xl border border-slate-700">
            <h2 class="text-xl font-semibold mb-4 text-white border-b border-slate-800 pb-2">Final ICU Progress Note</h2>
            
             <!-- Refinement Box -->
            <div class="bg-slate-800 p-4 rounded-md mb-6 border border-slate-700">
                <label class="block text-xs font-bold text-rose-300 mb-2 uppercase">Consultant Q&A (Refine the plan)</label>
                <div class="flex space-x-2">
                    <input type="text" id="refine-input" class="flex-1 p-2 bg-slate-950 border border-slate-700 rounded text-white text-sm focus:border-rose-500 outline-none" placeholder="e.g., 'What is the target MAP?' or 'Sedation holiday protocol?'">
                    <button type="button" id="refine-btn" class="bg-rose-700 hover:bg-rose-600 text-white px-4 rounded font-medium text-sm">Ask</button>
                </div>
                <div id="refine-response" class="hidden mt-3 p-3 bg-slate-900 rounded text-sm text-slate-300 border border-slate-700 italic"></div>
            </div>

            <div class="bg-white text-black p-6 rounded-md shadow-inner max-h-[600px] overflow-y-auto note-preview font-mono text-xs md:text-sm leading-tight border-2 border-slate-600 mb-4 relative">
                <div class="absolute top-2 right-2 text-[10px] text-gray-400">GENERATED BY AI ICU CONSULTANT</div>
                <pre id="final-note-content" class="whitespace-pre-wrap"></pre>
            </div>
            
            <button type="button" id="copy-note-btn" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg border border-slate-600 flex items-center justify-center mb-6">
                <i class="fa-regular fa-copy mr-2"></i> Copy to EMR
            </button>
            <p id="copy-success" class="hidden mt-2 text-center text-green-400 font-semibold text-sm">Copied to clipboard!</p>

            <!-- References -->
            <div id="references-container" class="bg-slate-800 p-4 rounded border border-slate-700 mb-8 hidden">
                <h3 class="text-rose-400 font-bold mb-2 text-xs uppercase flex items-center">
                    <i class="fa-solid fa-book-medical mr-2"></i> Critical Care Guidelines & Evidence
                </h3>
                <ul id="references-list" class="list-disc ml-5 text-sm space-y-2 text-slate-400"></ul>
            </div>

            <div class="mt-6 flex justify-center space-x-6">
                <button type="button" id="final-back-btn" class="text-slate-500 hover:text-white underline text-sm">
                    Back to Review
                </button>
                <button type="button" id="start-over-btn" class="text-slate-500 hover:text-white underline text-sm">
                    Start New Patient
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { callGeminiApi, callGeminiText } from './js/api.js';
        import { setupSharing } from './js/sharing.js';

        // --- Global State ---
        // Setting apiKey to empty string as per instructions; environment handles auth.
        const keyPartA = "AIzaSyDuDdz2_vEtk48eHM4mnKTW5FRnUQ";
        const keyPartB = "XXSJY";
        const apiKey = keyPartA + keyPartB;
        const jsonBinKey = "$2a$10$J/Gr0x7KT4o8YHMdHtRgV.MokfRSRnPPdXBI5jJidEiqrvJfbH5Py";
        
        let state = {
            mode: "Initial", // or "Followup"
            age: "",
            location: "",
            codeStatus: "",
            hpi: "",
            pmh: "",
            priorNote: "",
            events: "",
            vitals: "",
            vent: "",
            labs: "",
            lines: "",
            questions: [],
            answers: [],
            generatedPlan: null
        };

        // --- DOM Elements ---
        const sections = {
            intake: document.getElementById('section-intake'),
            questions: document.getElementById('section-questions'),
            review: document.getElementById('section-review'),
            final: document.getElementById('section-final')
        };
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorBoxes = {
            intake: document.getElementById('error-message-intake'),
            questions: document.getElementById('error-message-questions')
        };
        
        // --- Toggle Logic ---
        const btnInitial = document.getElementById('btn-initial');
        const btnFollowup = document.getElementById('btn-followup');
        const initialFields = document.getElementById('initial-fields');
        const followupFields = document.getElementById('followup-fields');

        function setMode(mode) {
            state.mode = mode;
            if (mode === 'Initial') {
                btnInitial.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-rose-600 text-white shadow";
                btnFollowup.className = "px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-white";
                initialFields.classList.remove('hidden');
                followupFields.classList.add('hidden');
            } else {
                btnInitial.className = "px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-white";
                btnFollowup.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-rose-600 text-white shadow";
                initialFields.classList.add('hidden');
                followupFields.classList.remove('hidden');
            }
        }

        btnInitial.addEventListener('click', () => setMode('Initial'));
        btnFollowup.addEventListener('click', () => setMode('Followup'));

        // --- Helpers ---
        function showLoading(isLoading, text = "Processing...") {
            document.getElementById('loading-text').textContent = text;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            if (isLoading) Object.values(sections).forEach(s => s.classList.add('hidden'));
        }

        function showSection(name) {
            showLoading(false);
            Object.keys(sections).forEach(key => sections[key].classList.toggle('hidden', key !== name));
            window.scrollTo(0, 0);
        }

        function showError(section, msg) {
            if(errorBoxes[section]) {
                errorBoxes[section].textContent = msg;
                errorBoxes[section].classList.remove('hidden');
                errorBoxes[section].classList.add('active');
            }
        }

        function clearErrors() {
            Object.values(errorBoxes).forEach(box => {
                box.classList.add('hidden');
                box.classList.remove('active');
            });
        }

        // --- Step 1: Intake Logic ---
        document.getElementById('load-example-btn').addEventListener('click', () => {
            setMode('Initial');
            document.getElementById('age-input').value = "68yo F";
            document.getElementById('location-input').value = "ICU";
            document.getElementById('code-status').value = "Full Code";
            document.getElementById('hpi-input').value = "Admitted from ER with hypotension (80/40), fever (39C), and altered mental status. History of UTI.";
            document.getElementById('pmh-input').value = "DM2, HTN, CKD stage 3";
            document.getElementById('vitals-input').value = "BP 90/50 (post 2L fluid), HR 115, RR 26, O2 94% on 4L NC";
            document.getElementById('vent-input').value = "N/A - NC 4L";
            document.getElementById('labs-input').value = "WBC 22, Lactate 4.2, Cr 1.9 (baseline 1.4), K 3.8";
            document.getElementById('lines-input').value = "R IJ Central Line, Foley";
        });

        document.getElementById('intake-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();
            
            // Gather state
            state.age = document.getElementById('age-input').value;
            state.location = document.getElementById('location-input').value;
            state.codeStatus = document.getElementById('code-status').value;
            state.vitals = document.getElementById('vitals-input').value;
            state.vent = document.getElementById('vent-input').value;
            state.labs = document.getElementById('labs-input').value;
            state.lines = document.getElementById('lines-input').value;
            state.hpi = document.getElementById('hpi-input').value;
            state.pmh = document.getElementById('pmh-input').value;
            state.priorNote = document.getElementById('prior-note-input').value;
            state.events = document.getElementById('events-input').value;

            if(!state.age) return showError('intake', 'Age is required.');
            
            let clinicalContext = `Patient: ${state.age}. Loc: ${state.location}. Code: ${state.codeStatus}.\n`;
            clinicalContext += `Vitals: ${state.vitals}. Vent/O2: ${state.vent}. Labs: ${state.labs}. Lines: ${state.lines}.\n`;
            
            if (state.mode === 'Initial') {
                clinicalContext += `Type: Initial Consult. HPI: ${state.hpi}. PMH: ${state.pmh}.`;
                if(state.hpi.length < 5) return showError('intake', 'Please provide an HPI.');
            } else {
                clinicalContext += `Type: Follow-up/Progress Note.\nPrior Note: ${state.priorNote}\n24hr Events: ${state.events}`;
                if(state.events.length < 5 && state.priorNote.length < 5) return showError('intake', 'Please provide 24hr events or a prior note.');
            }

            showLoading(true, "Consulting Critical Care Guidelines...");

            const systemPrompt = `
                You are an expert ICU Intensivist. Review the clinical data.
                Generate 5-7 targeted clarification questions to refine the plan for a SYSTEMS-BASED NOTE.
                Prioritize missing data for Neuro, CV (pressors/echo), Resp (ABG/Vent), Renal (UOP), and ID (Culture data).
                Return strictly JSON: { "questions": ["Question 1", "Question 2"...] }
            `;

            try {
                const result = await callGeminiApi(apiKey, systemPrompt, clinicalContext);
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                result.questions.forEach((q, i) => {
                    container.innerHTML += `
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <label class="block text-sm text-rose-300 mb-1 font-medium">${q}</label>
                            <input type="text" data-q="${q}" class="w-full p-2 border-b border-slate-600 bg-transparent text-white focus:border-rose-500 outline-none transition-colors" placeholder="Answer...">
                        </div>`;
                });
                showSection('questions');
            } catch (err) {
                console.error(err);
                showError('intake', 'Consultation failed. Ensure all fields are filled.');
                showSection('intake');
            }
        });

        document.getElementById('questions-back-btn').addEventListener('click', () => showSection('intake'));

        // --- Step 2: Generate Plan ---
        document.getElementById('questions-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            state.answers = [];
            document.querySelectorAll('#questions-container input').forEach(inp => {
                state.answers.push({ q: inp.dataset.q, a: inp.value });
            });

            showLoading(true, "Synthesizing Systems-Based Plan...");

            let contextData = `Mode: ${state.mode}\nPatient: ${state.age}\nCode Status: ${state.codeStatus}\n`;
            contextData += `Vitals: ${state.vitals}\nVent: ${state.vent}\nLabs: ${state.labs}\nLines: ${state.lines}\n`;
            
            if(state.mode === 'Initial') {
                contextData += `HPI: ${state.hpi}\nPMH: ${state.pmh}\n`;
            } else {
                contextData += `Prior Note: ${state.priorNote}\n24hr Events: ${state.events}\n`;
            }

            state.answers.forEach(item => contextData += `Q: ${item.q} A: ${item.a}\n`);

            const systemPrompt = `
                You are an expert Intensivist. Generate a comprehensive ICU SYSTEMS-BASED NOTE.
                
                STRUCTURE:
                1. Assessment/Summary: A synthesis paragraph of the current status.
                2. Systems: Neuro, CV, Resp, Renal/Fluids/GI/Endo, ID/Heme.
                   - CRITICAL FORMATTING FOR SYSTEMS:
                   For each system key (neuro, cv, etc.), the returned value MUST be a formatted string starting with:
                   "Diagnosis: [Diagnosis Name] [ICD-10 Code]
                   Assessment: [1 sentence pathophysiology/assessment]
                   Plan:
                   - [Specific Bullet 1]
                   - [Specific Bullet 2]"
                   
                3. ABCDE Bundle: A strict checklist for Awakening, Breathing, Coordination, Delirium, Early Mobility.
                
                OUTPUT JSON SCHEMA:
                {
                    "assessment": "Synthesis paragraph...",
                    "systems": {
                        "neuro": "string (formatted as above)",
                        "cv": "string (formatted as above)",
                        "resp": "string (formatted as above)",
                        "renal_gi_endo": "string (formatted as above)",
                        "id_heme": "string (formatted as above)"
                    },
                    "abcde": {
                        "a": "Plan for Awakening",
                        "b": "Plan for Breathing",
                        "c": "Coordination plan",
                        "d": "Delirium status/plan",
                        "e": "Mobility plan"
                    },
                    "references": [ {"title": "string (e.g. SCCM Sepsis Guidelines 2021)", "url": "string"} ]
                }
            `;

            try {
                const result = await callGeminiApi(apiKey, systemPrompt, contextData);
                state.generatedPlan = result;
                
                // Populate Review
                document.getElementById('assessment-summary').textContent = result.assessment;
                document.getElementById('sys-neuro').value = result.systems.neuro;
                document.getElementById('sys-cv').value = result.systems.cv;
                document.getElementById('sys-resp').value = result.systems.resp;
                document.getElementById('sys-renal').value = result.systems.renal_gi_endo;
                document.getElementById('sys-heme').value = result.systems.id_heme;
                
                showSection('review');
            } catch (err) {
                console.error(err);
                showError('questions', 'Failed to generate plan.');
                showSection('questions');
            }
        });
        
        document.getElementById('review-back-btn').addEventListener('click', () => showSection('questions'));

        // --- Step 3: Finalize ---
        document.getElementById('review-finalize-btn').addEventListener('click', () => {
            const now = new Date();
            const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString();
            
            let note = `*** CRITICAL CARE ${state.mode.toUpperCase()} NOTE ***\n`;
            note += `Date: ${timeString}\n`;
            note += `Pt: ${state.age} | ${state.location} | ${state.codeStatus}\n`;
            note += `-------------------------------------------\n`;
            
            if(state.mode === 'Initial') {
                note += `\nHPI/REASON FOR CONSULT:\n${state.hpi}\n\nPMH:\n${state.pmh}\n`;
            } else {
                note += `\n24 HOUR EVENTS / OVERNIGHT:\n${state.events}\n`;
            }
            
            note += `\nOBJECTIVE:\n`;
            note += `Vitals: ${state.vitals}\n`;
            note += `Resp: ${state.vent}\n`;
            note += `Labs: ${state.labs}\n`;
            note += `Lines: ${state.lines}\n`;
            
            note += `\n-------------------------------------------\n`;
            note += `ASSESSMENT:\n${document.getElementById('assessment-summary').textContent}\n\n`;
            
            note += `SYSTEMS PLAN:\n`;
            
            note += `\nNEURO / PAIN / SEDATION:\n`;
            note += document.getElementById('sys-neuro').value;
            
            note += `\n\nCARDIOVASCULAR:\n`;
            note += document.getElementById('sys-cv').value;
            
            note += `\n\nRESPIRATORY:\n`;
            note += document.getElementById('sys-resp').value;
            
            note += `\n\nRENAL / GI / ENDO / FLUIDS:\n`;
            note += document.getElementById('sys-renal').value;
            
            note += `\n\nID / HEME / PROPHYLAXIS:\n`;
            note += document.getElementById('sys-heme').value;
            
            note += `\n\n-------------------------------------------\n`;
            note += `ABCDE BUNDLE COMPLIANCE:\n`;
            
            const p = state.generatedPlan.abcde;
            const check = (id) => document.getElementById(id).checked ? "[x]" : "[ ]";
            
            note += `${check('abcde-a')} A: ${p.a}\n`;
            note += `${check('abcde-b')} B: ${p.b}\n`;
            note += `${check('abcde-c')} C: ${p.c}\n`;
            note += `${check('abcde-d')} D: ${p.d}\n`;
            note += `${check('abcde-e')} E: ${p.e}\n`;
            
            document.getElementById('final-note-content').textContent = note;

            // Render References
            const refList = document.getElementById('references-list');
            refList.innerHTML = '';
            if(state.generatedPlan.references && state.generatedPlan.references.length) {
                state.generatedPlan.references.forEach(r => {
                    refList.innerHTML += `<li><a href="${r.url}" target="_blank" class="text-rose-400 hover:underline">${r.title}</a></li>`;
                });
                document.getElementById('references-container').classList.remove('hidden');
            } else {
                document.getElementById('references-container').classList.add('hidden');
            }

            showSection('final');
        });

        // Refine Button Logic
        document.getElementById('refine-btn').addEventListener('click', async () => {
            const q = document.getElementById('refine-input').value;
            const box = document.getElementById('refine-response');
            if(!q) return;
            
            box.classList.remove('hidden');
            box.textContent = "Consulting SCCM Guidelines...";
            
            const sys = "You are a concise ICU Consultant. Answer based on SCCM/ESICM guidelines and the specific patient context.";
            const ctx = `Patient: ${state.age}. Condition: ${document.getElementById('assessment-summary').textContent}. Question: ${q}`;
            
            try {
                const ans = await callGeminiText(apiKey, sys, ctx);
                box.textContent = `Consultant: ${ans}`;
            } catch(e) {
                box.textContent = "Connection error.";
            }
        });

        document.getElementById('copy-note-btn').addEventListener('click', () => {
            const text = document.getElementById('final-note-content').textContent;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                const succ = document.getElementById('copy-success');
                succ.classList.remove('hidden');
                setTimeout(() => succ.classList.add('hidden'), 2000);
            } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(textArea);
        });

        document.getElementById('final-back-btn').addEventListener('click', () => showSection('review'));
        document.getElementById('start-over-btn').addEventListener('click', () => location.reload());

        // --- Sharing Setup ---
        function getSystemsData() {
            return {
                neuro: document.getElementById('sys-neuro').value,
                cv: document.getElementById('sys-cv').value,
                resp: document.getElementById('sys-resp').value,
                renal: document.getElementById('sys-renal').value,
                heme: document.getElementById('sys-heme').value,
                abcde: {
                    a: document.getElementById('abcde-a').checked,
                    b: document.getElementById('abcde-b').checked,
                    c: document.getElementById('abcde-c').checked,
                    d: document.getElementById('abcde-d').checked,
                    e: document.getElementById('abcde-e').checked
                },
                assessment: document.getElementById('assessment-summary').textContent
            };
        }

        setupSharing({
            apiKey: jsonBinKey,
            getState: () => {
                // Sync inputs
                state.age = document.getElementById('age-input').value;
                state.location = document.getElementById('location-input').value;
                state.codeStatus = document.getElementById('code-status').value;
                state.vitals = document.getElementById('vitals-input').value;
                state.vent = document.getElementById('vent-input').value;
                state.labs = document.getElementById('labs-input').value;
                state.lines = document.getElementById('lines-input').value;
                state.hpi = document.getElementById('hpi-input').value;
                state.pmh = document.getElementById('pmh-input').value;
                state.priorNote = document.getElementById('prior-note-input').value;
                state.events = document.getElementById('events-input').value;

                // Sync Questions Answers
                const qInputs = document.querySelectorAll('#questions-container input');
                if (qInputs.length > 0) {
                    state.answers = [];
                    qInputs.forEach(inp => {
                        state.answers.push({ q: inp.dataset.q, a: inp.value });
                    });
                }

                return {
                    appState: state,
                    systemsData: getSystemsData(),
                    currentSection: !document.getElementById('section-final').classList.contains('hidden') ? 'final' :
                                    !document.getElementById('section-review').classList.contains('hidden') ? 'review' :
                                    !document.getElementById('section-questions').classList.contains('hidden') ? 'questions' : 'intake',
                    finalNoteContent: document.getElementById('final-note-content').textContent,
                    refineHistory: document.getElementById('refine-response').textContent
                };
            },
            restoreState: (saved) => {
                if(saved.appState) Object.assign(state, saved.appState);

                // Restore Mode
                setMode(state.mode || 'Initial');

                // Restore Inputs
                document.getElementById('age-input').value = state.age || "";
                document.getElementById('location-input').value = state.location || "ICU";
                document.getElementById('code-status').value = state.codeStatus || "Full Code";
                document.getElementById('vitals-input').value = state.vitals || "";
                document.getElementById('vent-input').value = state.vent || "";
                document.getElementById('labs-input').value = state.labs || "";
                document.getElementById('lines-input').value = state.lines || "";
                document.getElementById('hpi-input').value = state.hpi || "";
                document.getElementById('pmh-input').value = state.pmh || "";
                document.getElementById('prior-note-input').value = state.priorNote || "";
                document.getElementById('events-input').value = state.events || "";

                // Restore Questions
                if (state.questions && state.questions.length > 0) {
                    const container = document.getElementById('questions-container');
                    container.innerHTML = '';
                    state.questions.forEach(q => {
                        const ans = state.answers ? state.answers.find(a => a.q === q) : null;
                        const val = ans ? ans.a : "";
                        container.innerHTML += `
                            <div class="bg-slate-800 p-3 rounded border border-slate-700">
                                <label class="block text-sm text-rose-300 mb-1 font-medium">${q}</label>
                                <input type="text" data-q="${q}" value="${val}" class="w-full p-2 border-b border-slate-600 bg-transparent text-white focus:border-rose-500 outline-none transition-colors" placeholder="Answer...">
                            </div>`;
                    });
                }

                // Restore Systems Data
                if (saved.systemsData) {
                    const sys = saved.systemsData;
                    document.getElementById('sys-neuro').value = sys.neuro || "";
                    document.getElementById('sys-cv').value = sys.cv || "";
                    document.getElementById('sys-resp').value = sys.resp || "";
                    document.getElementById('sys-renal').value = sys.renal || "";
                    document.getElementById('sys-heme').value = sys.heme || "";
                    document.getElementById('assessment-summary').textContent = sys.assessment || "";

                    if(sys.abcde) {
                        document.getElementById('abcde-a').checked = sys.abcde.a;
                        document.getElementById('abcde-b').checked = sys.abcde.b;
                        document.getElementById('abcde-c').checked = sys.abcde.c;
                        document.getElementById('abcde-d').checked = sys.abcde.d;
                        document.getElementById('abcde-e').checked = sys.abcde.e;
                    }
                }

                // Restore Final Note
                if (saved.finalNoteContent) {
                    document.getElementById('final-note-content').textContent = saved.finalNoteContent;
                }
                if (saved.refineHistory) {
                    document.getElementById('refine-response').textContent = saved.refineHistory;
                    document.getElementById('refine-response').classList.remove('hidden');
                }

                showSection(saved.currentSection || 'intake');
            }
        });

        // Init
        if (!new URLSearchParams(window.location.search).get('id')) {
            setMode('Initial');
            showSection('intake');
        }
    </script>
</body>
</html>
