<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Medical Specialist Consult Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gemini: {
                            900: '#0b0f19', // Deepest background
                            800: '#13161f', // Sidebar/Surface
                            700: '#1e2330', // Hover states
                            600: '#2d3342', // Borders
                            accent: '#3b82f6', // Blue accent
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: theme('colors.gray.300'),
                                strong: { color: theme('colors.white') },
                                a: { color: theme('colors.blue.400') },
                                h1: { color: theme('colors.white') },
                                h2: { color: theme('colors.white') },
                                h3: { color: theme('colors.white') },
                                h4: { color: theme('colors.white') },
                            },
                        },
                    }),
                }
            }
        }
    </script>

    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Scrollbar styling */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Dr. Holtkamp "Thinking Brain" Animation */
        @keyframes brain-think {
            0% { 
                color: #60a5fa; /* Blue */
                transform: scale(1);
                filter: drop-shadow(0 0 2px rgba(96, 165, 250, 0.2));
            }
            33% { 
                color: #a78bfa; /* Purple */
                transform: scale(1.15); 
                filter: drop-shadow(0 0 8px rgba(167, 139, 250, 0.4));
            }
            66% { 
                color: #2dd4bf; /* Teal */
                transform: scale(1);
                filter: drop-shadow(0 0 2px rgba(45, 212, 191, 0.2));
            }
            100% { 
                color: #60a5fa; /* Blue */
                transform: scale(1);
                filter: drop-shadow(0 0 2px rgba(96, 165, 250, 0.2));
            }
        }
        .animate-brain {
            animation: brain-think 3s ease-in-out infinite;
        }

        /* Card Styles */
        .card {
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .card-blocked {
            opacity: 0.5;
            filter: grayscale(0.8);
            pointer-events: none;
            user-select: none;
            background: #0f172a;
            border: 1px solid #1e293b;
        }
        
        /* Glass effect for search bar */
        .glass-search {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(8px);
        }

        /* Faded Background Image Style */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Placeholder pattern since no image URL provided */
            background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 32px 32px;
            opacity: 0.5; 
            pointer-events: none; 
        }

        /* Simple Prose for Markdown Content */
        .prose-content ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose-content ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose-content strong { color: #e2e8f0; font-weight: 700; }
        .prose-content h1, .prose-content h2, .prose-content h3 { color: #f8fafc; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .prose-content li { margin-bottom: 0.25rem; }
        /* Fix for superscripts in prose */
        .prose-content sup { color: #3b82f6; font-weight: 600; font-size: 0.75em; margin-left: 1px; }
    </style>
</head>

<body class="bg-gemini-900 text-gray-200 h-screen overflow-hidden flex selection:bg-sky-500 selection:text-white relative">

<!-- Background Image Container -->
<div class="background-overlay"></div>

<!-- =================================================================== -->
<!-- DISCLAIMER MODAL -->
<!-- =================================================================== -->
<div id="disclaimerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4 transition-opacity duration-300">
  <div id="disclaimerDialog" class="w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl bg-slate-800 border border-slate-700 p-6 text-left text-slate-100 shadow-2xl ring-1 ring-white/10" tabindex="-1">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 id="disclaimerTitle" class="text-2xl font-bold mb-1 text-white">Quick challenge — one small step</h2>
        <p class="text-sm text-slate-400">Use only de-identified examples. You'll be prompted if something looks like PHI.</p>
      </div>
      <div class="hidden sm:inline-flex items-center gap-2 text-sm">
        <span class="inline-block px-2.5 py-0.5 rounded-full bg-amber-500/10 text-amber-500 border border-amber-500/20 font-medium text-xs uppercase tracking-wider">Safety First</span>
      </div>
    </div>
    <hr class="my-4 border-slate-700/60"/>
    <p id="disclaimerDesc" class="text-sm text-slate-300 mb-3 leading-relaxed">
      This site generates consult drafts and provides clinical decision support. It does <strong>not</strong> replace your clinical judgment. Enter only de-identified information here.
    </p>
    <div class="bg-amber-950/30 border-l-4 border-amber-500 p-3 mb-4 rounded-r">
        <p class="text-sm font-semibold text-amber-200">This platform is <u>NOT HIPAA compliant</u>. Do <strong>NOT</strong> enter PHI.</p>
    </div>
    <div class="flex flex-col gap-4 mt-6 pt-4 border-t border-slate-700/60">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
          <div class="space-y-2">
            <label class="flex items-center gap-3 cursor-pointer group">
                <input id="ackCheckbox" type="checkbox" class="peer h-5 w-5 rounded border-slate-600 bg-slate-700 text-amber-500 focus:ring-amber-500/50" />
                <span class="text-sm text-slate-300 group-hover:text-white transition-colors">I confirm I will not enter PHI.</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer group">
                <input id="dontShowAgain" type="checkbox" class="peer h-5 w-5 rounded border-slate-600 bg-slate-700 text-sky-500 focus:ring-sky-500/50" />
                <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Don't show this again on this device</span>
            </label>
          </div>
          <button id="ackBtn" onclick="acceptDisclaimer()" disabled class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-2.5 rounded-xl bg-amber-600 text-white font-semibold shadow-lg shadow-amber-900/20 hover:bg-amber-500 disabled:opacity-50 disabled:cursor-not-allowed">
            I Understand — Continue
          </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const MODAL_KEY = 'consultDisclaimerAck_v1';
  const modal = document.getElementById('disclaimerModal');
  const ackCheckbox = document.getElementById('ackCheckbox');
  const ackBtn = document.getElementById('ackBtn');
  const dontShowAgain = document.getElementById('dontShowAgain');

  try {
    if (localStorage.getItem(MODAL_KEY)) {
      if (modal) modal.style.display = 'none';
      return;
    }
  } catch (e) {}

  document.body.style.overflow = 'hidden';

  if(ackCheckbox){
      ackCheckbox.addEventListener('change', () => {
        ackBtn.disabled = !ackCheckbox.checked;
        ackBtn.classList.toggle('opacity-50', !ackCheckbox.checked);
        ackBtn.classList.toggle('cursor-not-allowed', !ackCheckbox.checked);
      });
  }

  window.acceptDisclaimer = function() {
    try {
      if (dontShowAgain && dontShowAgain.checked) {
        localStorage.setItem(MODAL_KEY, new Date().toISOString());
      }
    } catch (err) {}
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => { modal.style.display = 'none'; }, 300);
    }
    document.body.style.overflow = '';
  };
})();
</script>

<!-- =================================================================== -->
<!-- SIDEBAR -->
<!-- =================================================================== -->
<aside id="main-sidebar" class="w-64 bg-gemini-800 flex-col border-r border-white/5 hidden md:flex transition-all duration-300 z-40 fixed md:relative h-full">
    <!-- Branding Area -->
    <div class="p-6 pb-2 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="material-symbols-outlined text-white text-[20px]">medical_services</span>
            </div>
            <div class="flex flex-col">
                <span class="font-bold text-slate-100 tracking-tight">MedCon Portal</span>
                <span class="text-[10px] text-slate-500 uppercase tracking-wider font-medium">MTF Provider Portal</span>
            </div>
        </div>
        <!-- Mobile Close Button -->
        <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>

    <!-- Scrollable Nav -->
    <div class="flex-1 overflow-y-auto custom-scroll px-3 py-2">
        
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 px-3">Main Menu</div>
        <nav class="space-y-1 mb-8">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-white bg-blue-600/10 border border-blue-600/20 transition-all group text-left">
                <span class="material-symbols-outlined text-[20px] text-blue-400">dashboard</span>
                <span class="text-sm font-medium">Dashboard</span>
            </button>

            <button onclick="switchView('consults')" id="nav-consults" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-white/5 hover:text-white transition-all group text-left">
                <span class="material-symbols-outlined text-[20px] text-slate-500 group-hover:text-teal-400">clinical_notes</span>
                <span class="text-sm font-medium">Consult Generator</span>
            </button>

            <button onclick="switchView('journal')" id="nav-journal" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-white/5 hover:text-white transition-all group text-left">
                <span class="material-symbols-outlined text-[20px] text-slate-500 group-hover:text-amber-400">menu_book</span>
                <span class="text-sm font-medium">Journal Clubs</span>
            </button>
        </nav>

        <!-- Quick References -->
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 px-3">Quick Reference</div>
        <nav class="space-y-1 mb-6">
            <button onclick="openFrame('https://www.express-scripts.com/frontend/open-enrollment/tricare/fst/#/', 'Tricare Formulary')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">medication</span>
                <span class="text-sm truncate">Formulary (DOD)</span>
            </button>
            
            <button onclick="openFrame('https://www.mdcalc.com/', 'MedCalc')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">calculate</span>
                <span class="text-sm truncate">MedCalc</span>
            </button>

            <button onclick="openFrame('https://www.openevidence.com/', 'OpenEvidence')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">search</span>
                <span class="text-sm truncate">OpenEvidence</span>
            </button>

            <button onclick="openFrame('https://www.pubmed.ai/search/', 'PubMed AI')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">science</span>
                <span class="text-sm truncate">PubMed AI</span>
            </button>

            <button onclick="openFrame('https://chat.genai.army.mil/login?code=CDAO-NORTHCOM/', 'Ask Sage')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">military_tech</span>
                <span class="text-sm truncate">Ask Sage</span>
            </button>
        </nav>
        <!-- Military (CAC Required) -->
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 px-3 border-t border-white/5 pt-4">Military (CAC Required)</div>
        <nav class="space-y-1">
            <button onclick="openFrame('https://genesis.health.mil', 'Genesis (EMR)')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">dns</span>
                <span class="text-sm truncate">Genesis (EMR)</span>
            </button>

            <button onclick="openFrame('https://www.mods.army.mil', 'MODS')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">admin_panel_settings</span>
                <span class="text-sm truncate">MODS</span>
            </button>

            <button onclick="openFrame('https://client.wvd.azure.us/arm/webclient/index.html', 'Army Remote Dashboard')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition-colors group text-left">
                <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-slate-300">monitor_heart</span>
                <span class="text-sm truncate">Army Remote Dash</span>
            </button>
        </nav>
    </div>
</aside>

<!-- Overlay for mobile sidebar -->
<div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass-search"></div>

<!-- =================================================================== -->
<!-- MAIN CONTENT AREA -->
<!-- =================================================================== -->
<main class="flex-1 flex flex-col relative h-full bg-gemini-900">
    
    <!-- Top Bar (Header) -->
    <header class="h-16 flex-shrink-0 flex items-center justify-between px-6 border-b border-white/5 bg-gemini-900/95 backdrop-blur-sm z-30">
        <!-- Left: Page Title -->
        <div class="flex items-center gap-4">
            <!-- Added onclick to toggle Sidebar -->
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">menu</span>
            </button>
            <h1 id="page-title" class="text-xl font-bold text-slate-100">
                Dashboard
            </h1>
        </div>

        <!-- Right: Search & External Link Action -->
        <div class="flex items-center gap-4">
             <!-- Generic Search (Visual only for now) -->
             <div class="relative w-64 hidden sm:block">
                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="material-symbols-outlined text-slate-500 text-[18px]">search</span>
                 </div>
                 <input type="text" 
                        class="glass-search border border-slate-700 text-slate-200 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2 placeholder-slate-500 transition-all focus:bg-slate-800" 
                        placeholder="Search protocols...">
            </div>
            
            <!-- External Link Button -->
            <div id="frame-controls" class="hidden flex items-center gap-2">
                <button onclick="switchView('dashboard')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white transition-colors text-xs font-medium">
                    <span class="material-symbols-outlined text-[14px]">close</span>
                    <span>Close View</span>
                </button>
                <a id="external-link-btn" href="#" target="_blank" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-600/10 text-blue-400 hover:bg-blue-600 hover:text-white transition-colors text-xs font-medium border border-blue-600/20">
                    <span>Open in New Tab</span>
                    <span class="material-symbols-outlined text-[14px]">open_in_new</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Content Views Container -->
    <div class="flex-1 overflow-hidden relative">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-dashboard" class="absolute inset-0 flex flex-col transition-opacity duration-300">
            <div class="flex-1 overflow-y-auto custom-scroll p-6 pb-32">
                <div class="max-w-6xl mx-auto w-full animate-fade-in space-y-8">
                    
                    <!-- 1. Hero / Chat Section -->
                    <div class="relative rounded-3xl overflow-hidden p-8 border border-white/5 shadow-2xl">
                         <!-- Background Gradient -->
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-900/40 via-gemini-800 to-gemini-900 z-0"></div>
                        <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>

                        <div class="relative z-10">
                            <h2 class="text-3xl font-bold text-white mb-2">How can I help you? </h2>
                            <p class="text-slate-400 mb-8 max-w-2xl">
                                
                            </p>

                            <!-- Chat Input -->
                            <div class="bg-gemini-800/80 backdrop-blur-md border border-slate-600/50 rounded-2xl shadow-lg flex flex-col relative focus-within:ring-2 focus-within:ring-blue-500/30 transition-all max-w-3xl">
                                <textarea 
                                    id="chatInput"
                                    placeholder="Clinical query (e.g., 'Latest STEMI guidelines')..." 
                                    class="w-full bg-transparent text-slate-200 placeholder-slate-500 p-4 pl-5 min-h-[60px] max-h-48 resize-none focus:outline-none rounded-2xl"
                                    rows="1"
                                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                                
                                <div class="flex items-center justify-end px-3 pb-3 relative">
                                    <!-- New Question Button (Hidden by default) -->
                                    <button id="newQuestionBtn" onclick="resetConsult()" class="hidden absolute left-3 flex items-center gap-1.5 px-3 py-1.5 bg-slate-700/50 hover:bg-slate-600 text-slate-300 hover:text-white text-xs font-medium rounded-lg border border-slate-600 transition-all">
                                        <span class="material-symbols-outlined text-[14px]">refresh</span>
                                        New Question
                                    </button>
                                    
                                    <button id="askBtn" onclick="askDrHoltkamp()" class="px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-500 transition-all shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed">
                                        Ask Dr. Holtkamp
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-3 ml-1">
                                Strictly evidence-based (guidelines/RCTs). No PHI.
                            </p>

                            <!-- DYNAMIC RESPONSE AREA -->
                            <div id="responseArea" class="hidden mt-6 bg-gemini-800/90 backdrop-blur-sm p-6 rounded-2xl border border-blue-500/30 shadow-2xl animate-fade-in relative overflow-hidden">
                                <!-- Content injected by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- 2. Frequent Services -->
                    <div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                            <!-- Card 1: ADTMC+ -->
                            <div onclick="openFrame('ADTMCplus.html', 'ADTMC+')" class="block group cursor-pointer">
                                <div class="bg-gemini-800 hover:bg-slate-800 border border-slate-700/50 rounded-xl p-5 h-full transition-all hover:shadow-lg hover:shadow-indigo-500/10 hover:-translate-y-1">
                                    <div class="w-10 h-10 rounded-lg bg-indigo-500/10 flex items-center justify-center mb-4 group-hover:bg-indigo-500/20 transition-colors">
                                        <span class="material-symbols-outlined text-indigo-400">medical_services</span>
                                    </div>
                                    <h4 class="text-base font-bold text-slate-100 mb-1">ADTMC+</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed">
                                        Sick call services for providers. Generate notes fast.
                                    </p>
                                </div>
                            </div>

                            <!-- Card 2: General Journal Club -->
                            <div onclick="openFrame('journalclub.html', 'General Journal Club')" class="block group cursor-pointer">
                                <div class="bg-gemini-800 hover:bg-slate-800 border border-slate-700/50 rounded-xl p-5 h-full transition-all hover:shadow-lg hover:shadow-red-500/10 hover:-translate-y-1">
                                    <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center mb-4 group-hover:bg-red-500/20 transition-colors">
                                        <span class="material-symbols-outlined text-red-400">menu_book</span>
                                    </div>
                                    <h4 class="text-base font-bold text-slate-100 mb-1">General Journal Club</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed">
                                        Evidence summaries and audio breakdowns.
                                    </p>
                                </div>
                            </div>

                            <!-- Card 3: PubMed AI -->
                            <div onclick="openFrame('https://www.pubmed.ai/search', 'PubMed AI')" class="block group cursor-pointer">
                                <div class="bg-gemini-800 hover:bg-slate-800 border border-slate-700/50 rounded-xl p-5 h-full transition-all hover:shadow-lg hover:shadow-blue-500/10 hover:-translate-y-1">
                                    <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center mb-4 group-hover:bg-blue-500/20 transition-colors">
                                        <span class="material-symbols-outlined text-blue-400">science</span>
                                    </div>
                                    <h4 class="text-base font-bold text-slate-100 mb-1">PubMed AI</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed">
                                        Search millions of citations with AI assistance.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW 2: CONSULTS (GRID) -->
        <div id="view-consults" class="absolute inset-0 overflow-y-auto custom-scroll p-6 hidden">
            <div class="max-w-7xl mx-auto">
                <!-- IMPORTANT: Added ID 'cardContainer' here for the Search Script -->
                <div id="cardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                    
                    <!-- Search inside Consults -->
                    <div class="col-span-full mb-2">
                        <input id="consult-search" type="text" onkeyup="filterCards()" 
                               class="bg-gemini-800 border border-slate-700 text-slate-200 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full p-4 placeholder-slate-500 shadow-sm" 
                               placeholder="Filter specific specialty (e.g. Cardio)...">
                    </div>

                    <!-- 
                        UPDATED CARDS: 
                        Replaced <a href> with <div onclick="openFrame"> 
                        This keeps the user inside the 'Portal' experience.
                    -->

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col relative overflow-hidden group cursor-pointer"
                         onclick="openFrame('ADTMC.html', 'ADTMC')">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-green-500/5 rounded-bl-full -mr-4 -mt-4 transition-all group-hover:bg-green-500/10"></div>
                        <h3 class="text-xl font-bold text-white mb-2">ADTMC</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Medic sick call services.<br><strong class="text-green-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-green-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Start Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col relative overflow-hidden group cursor-pointer"
                         onclick="openFrame('ADTMCplus.html', 'ADTMC+')">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-500/5 rounded-bl-full -mr-4 -mt-4 transition-all group-hover:bg-indigo-500/10"></div>
                        <h3 class="text-xl font-bold text-white mb-2">ADTMC+</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Sick call for providers.<br><strong class="text-indigo-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-indigo-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Start Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('IM.html', 'Internal Medicine')">
                        <h3 class="text-xl font-bold text-white mb-2">Internal Medicine</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Adult hospital medicine.<br><strong class="text-blue-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('ICU.html', 'ICU')">
                        <h3 class="text-xl font-bold text-white mb-2">ICU</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Critical Care consults.<br><strong class="text-purple-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-purple-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('cardiology.html', 'Cardiology')">
                        <h3 class="text-xl font-bold text-white mb-2">Cardiology</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Consults for cardiovascular.<br><strong class="text-red-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-red-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>
                    
                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('neurology.html', 'Neurology')">
                        <h3 class="text-xl font-bold text-white mb-2">Neurology</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Brain + CNS consults.<br><strong class="text-yellow-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('pediatrics.html', 'Pediatrics')">
                        <h3 class="text-xl font-bold text-white mb-2">Pediatrics</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Infants + children.<br><strong class="text-pink-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-pink-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('psychiatry.html', 'Psychiatry')">
                        <h3 class="text-xl font-bold text-white mb-2">Psychiatry</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Mental health consults.<br><strong class="text-teal-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-teal-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>

                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('orthopedic_surgery.html', 'Orthopedics')">
                        <h3 class="text-xl font-bold text-white mb-2">Orthopedics</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Bone + joint consults.<br><strong class="text-orange-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-orange-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>
                    
                    <div class="card bg-gemini-800 border border-slate-700/50 rounded-2xl p-6 flex flex-col group cursor-pointer"
                         onclick="openFrame('rheumatology.html', 'Rheumatology')">
                        <h3 class="text-xl font-bold text-white mb-2">Rheumatology</h3>
                        <p class="text-slate-400 mb-6 flex-grow text-sm">Autoimmune consults.<br><strong class="text-cyan-400 text-xs">Note Generation</strong></p>
                        <button class="mt-auto w-full bg-slate-700 group-hover:bg-cyan-600 text-white font-medium py-2.5 px-4 rounded-xl text-center transition-all">Go to Consult</button>
                    </div>

                    <!-- Blocked Cards -->
                     <div class="card-blocked rounded-2xl p-6 flex flex-col">
                        <h3 class="text-xl font-bold text-slate-600 mb-2">Endocrinology</h3>
                        <p class="text-slate-700 mb-6 flex-grow text-sm">Hormone/metabolism.</p>
                        <span class="mt-auto w-full bg-slate-800 text-slate-500 font-medium py-2.5 px-4 rounded-xl text-center text-sm">Coming Soon</span>
                    </div>
                    <div class="card-blocked rounded-2xl p-6 flex flex-col">
                        <h3 class="text-xl font-bold text-slate-600 mb-2">Gastroenterology</h3>
                        <p class="text-slate-700 mb-6 flex-grow text-sm">Digestive consults.</p>
                        <span class="mt-auto w-full bg-slate-800 text-slate-500 font-medium py-2.5 px-4 rounded-xl text-center text-sm">Coming Soon</span>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW 3: JOURNAL CLUB (GRID) -->
        <div id="view-journal" class="absolute inset-0 overflow-y-auto custom-scroll p-6 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Main Journal Club -->
                    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-red-900/40 to-slate-900 border border-red-500/30 p-8 shadow-2xl group transition-all hover:border-red-500/60 cursor-pointer" onclick="openFrame('journalclub.html', 'General Journal Club')">
                         <div class="absolute top-0 right-0 w-64 h-64 bg-red-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none group-hover:bg-red-600/20 transition-all"></div>
                         <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="bg-red-500/20 p-2 rounded-lg text-red-400">
                                    <span class="material-symbols-outlined">menu_book</span>
                                </span>
                                <h3 class="text-2xl font-bold text-white">General Journal Club</h3>
                            </div>
                            <p class="text-slate-300 text-lg mb-8">
                                Evidence summaries, audio breakdowns, and landmark trials across all specialties.
                            </p>
                            <span class="inline-flex items-center justify-center px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-red-900/30">
                                Open Journal Club
                            </span>
                         </div>
                    </div>

                    <!-- Military Medicine -->
                    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-emerald-900/40 to-slate-900 border border-emerald-500/30 p-8 shadow-2xl group transition-all hover:border-emerald-500/60 cursor-pointer" onclick="openFrame('journalclub_mil.html', 'Military Medicine')">
                         <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none group-hover:bg-emerald-600/20 transition-all"></div>
                         <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400">
                                    <span class="material-symbols-outlined">medical_services</span>
                                </span>
                                <h3 class="text-2xl font-bold text-white">Military Medicine</h3>
                            </div>
                            <p class="text-slate-300 text-lg mb-8">
                                Operational medicine updates, TCCC guidelines, and deployment health resources.
                            </p>
                            <span class="inline-flex items-center justify-center px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-900/30">
                                Open Military Journal
                            </span>
                         </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW 4: IFRAME VIEWER -->
        <div id="view-iframe" class="absolute inset-0 flex flex-col hidden bg-white">
            <div class="w-full h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
            <!-- Added error handling fallback in logic -->
            <iframe id="main-frame" src="" class="w-full h-full border-0" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        </div>

    </div>
</main>

<script>
    // System Instruction Configuration for Dr. Holtkamp (Gemini Persona)
    const DR_HOLTKAMP_SYSTEM_INSTRUCTION = `Respond as Dr. Holtkamp, serving in the role of Expert Medical Educator.
Provide answers that are clear, concise, and precise, limited to a few short paragraphs with bullets only when necessary for structure.
All statements must be based solely on current medical guidelines, high-quality evidence, or reliable medical sources (AHA/ASA, ACC, IDSA, ATS, AAN, ACEP, Surviving Sepsis, NIH, DHA, DoD, Cochrane, NEJM/JAMA/Lancet RCTs).
Do not speculate beyond evidence; cite guideline or study sources in APA style with superscripted citations.
Use standard Markdown formatting. Do not use LaTeX-style formatting (e.g., Avoid $, {}, or \ for math/citations) unless absolutely necessary for a formula, and if used, ensure it is compatible with standard Markdown readers.
Tone should be authoritative, educational, and analytically rigorous.`;

    // Function to clean "amateur" characters and LaTeX artifacts
    function cleanMedicalResponse(text) {
        if (!text) return "";
        
        let cleaned = text;

        // 1. Remove $_ artifacts
        cleaned = cleaned.replace(/\$\_/g, "");

        // 2. Fix ${}^{number}$ or ${^number}$ artifacts -> <sup>number</sup>
        // Covers: ${}^{1}$, ${^1}$, $^1$
        cleaned = cleaned.replace(/\$\^?\{?\^?(\d+)\}?\$?/g, "<sup>$1</sup>");
        
        // 3. Fix standard LaTeX superscripts like $^2$ -> <sup>2</sup>
        cleaned = cleaned.replace(/\$\^(\d+)\$/g, "<sup>$1</sup>");

        // 4. Remove any remaining isolated $ signs that might look like math mode start/end
        // Be careful not to remove money signs like $500, so we check for space or EOL
        // This regex removes $ if it's likely a formatting artifact
        cleaned = cleaned.replace(/(^|\s)\$(\s|$)/g, "$1$2");

        return cleaned;
    }

    // New function to reset the consult state
    function resetConsult() {
        // Clear input
        document.getElementById('chatInput').value = '';
        
        // Hide response area and clear content
        const responseArea = document.getElementById('responseArea');
        responseArea.classList.add('hidden');
        responseArea.innerHTML = '';
        
        // Hide the "New Question" button
        document.getElementById('newQuestionBtn').classList.add('hidden');
    }

    async function askDrHoltkamp() {
        const queryInput = document.getElementById('chatInput');
        const query = queryInput.value;
        const responseArea = document.getElementById('responseArea');
        const askBtn = document.getElementById('askBtn');
        const newQuestionBtn = document.getElementById('newQuestionBtn');

        if (!query.trim()) return;

        // UI Updates: Loading state
        askBtn.disabled = true;
        askBtn.textContent = "Consulting...";
        responseArea.classList.remove('hidden');
        
        // Hide New Question button while loading
        newQuestionBtn.classList.add('hidden');

        // New Medical "Thinking Brain" Loader
        responseArea.innerHTML = `
            <div class="flex items-center gap-3 text-slate-400">
                <span class="material-symbols-outlined animate-brain text-3xl">psychology</span>
                <span class="font-medium text-sm tracking-wide">Dr. Holtkamp is reviewing clinical guidelines...</span>
            </div>
        `;

        // Configure API Call
        const apiKey = "AIzaSyDPIfqwivYMHpicaT2FfkJn5hDmQtQwV70";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: query }] }],
            systemInstruction: { parts: [{ text: DR_HOLTKAMP_SYSTEM_INSTRUCTION }] }
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);

            const data = await response.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated. Please clarify your clinical query.";

            // Clean the text before parsing Markdown
            text = cleanMedicalResponse(text);

            // Render Response with Markdown Parsing
            responseArea.innerHTML = `
                <div class="flex items-start gap-4 animate-fade-in">
                     <div class="w-10 h-10 rounded-xl bg-blue-600/20 border border-blue-500/30 flex items-center justify-center flex-shrink-0 mt-1">
                        <span class="material-symbols-outlined text-blue-400">smart_toy</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-white text-sm uppercase tracking-wider">Dr. Holtkamp Analysis</h3>
                            <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-0.5 rounded border border-slate-700">AI Generated • Review Verify</span>
                        </div>
                        <div class="prose-content text-slate-300 text-sm leading-relaxed">
                            ${marked.parse(text)}
                        </div>
                    </div>
                </div>
            `;
            
            // Show the "New Question" button after successful response
            newQuestionBtn.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            responseArea.innerHTML = `
                <div class="p-4 bg-red-900/20 border border-red-500/30 rounded-xl text-red-200 flex items-start gap-3">
                    <span class="material-symbols-outlined text-red-400">error</span>
                    <div>
                        <strong class="block font-semibold text-red-100 text-sm">Consult Error</strong>
                        <span class="text-xs opacity-80">Unable to reach Dr. Holtkamp service. Check network or API configuration.</span>
                    </div>
                </div>
            `;
            // Even on error, allow user to reset/try again
            newQuestionBtn.classList.remove('hidden');
        } finally {
            askBtn.disabled = false;
            askBtn.textContent = "Ask Dr. Holtkamp";
        }
    }

    // State management
    let currentView = 'dashboard';
    let isSidebarOpen = false;

    function toggleSidebar() {
        const sidebar = document.getElementById('main-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        isSidebarOpen = !isSidebarOpen;
        
        if (isSidebarOpen) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('flex', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'shadow-2xl');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('flex', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'shadow-2xl');
            overlay.classList.add('hidden');
        }
    }

    function switchView(viewId) {
        currentView = viewId;
        
        // Hide all views including iframe
        const views = ['view-dashboard', 'view-consults', 'view-journal', 'view-iframe'];
        views.forEach(id => document.getElementById(id).classList.add('hidden'));
        
        // Remove active styles from nav
        const navIds = ['nav-dashboard', 'nav-consults', 'nav-journal'];
        navIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('bg-blue-600/10', 'border', 'border-blue-600/20', 'text-white');
                el.classList.add('text-slate-400', 'hover:bg-white/5', 'hover:text-white');
            }
        });

        // Show selected view
        document.getElementById(`view-${viewId}`).classList.remove('hidden');

        // Set active style on nav
        const activeNav = document.getElementById(`nav-${viewId}`);
        if(activeNav) {
            activeNav.classList.remove('text-slate-400', 'hover:bg-white/5', 'hover:text-white');
            activeNav.classList.add('bg-blue-600/10', 'border', 'border-blue-600/20', 'text-white');
        }
        
        // Update Page Title
        const titles = {
            'dashboard': 'Dashboard',
            'consults': 'Consult Generator',
            'journal': 'Clinical Updates'
        };
        document.getElementById('page-title').textContent = titles[viewId] || 'Portal';

        // Hide external link buttons
        document.getElementById('frame-controls').classList.add('hidden');

        // Close sidebar if on mobile
        if(window.innerWidth < 768 && isSidebarOpen) {
            toggleSidebar();
        }
    }

    function openFrame(url, title) {
        // Hide all main views
        const views = ['view-dashboard', 'view-consults', 'view-journal'];
        views.forEach(id => document.getElementById(id).classList.add('hidden'));

        // Show iframe view
        const iframeContainer = document.getElementById('view-iframe');
        iframeContainer.classList.remove('hidden');
        
        const frame = document.getElementById('main-frame');
        frame.src = url;

        // Update Title
        document.getElementById('page-title').textContent = title;

        // Show External Link Controls
        const controls = document.getElementById('frame-controls');
        controls.classList.remove('hidden');
        controls.classList.add('flex'); // Ensure it displays as flex

        const extBtn = document.getElementById('external-link-btn');
        extBtn.href = url;

        // Reset sidebar active states
        const navIds = ['nav-dashboard', 'nav-consults', 'nav-journal'];
        navIds.forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('bg-blue-600/10', 'border', 'border-blue-600/20', 'text-white');
            el.classList.add('text-slate-400', 'hover:bg-white/5', 'hover:text-white');
        });

        // Close sidebar if on mobile
        if(window.innerWidth < 768 && isSidebarOpen) {
            toggleSidebar();
        }
    }

    function filterCards() {
        const term = document.getElementById("consult-search").value.toLowerCase();
        // Updated selector to find cards within the specific ID
        const cards = document.querySelectorAll("#cardContainer .card"); 
        
        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            if (text.includes(term)) {
                card.style.display = ""; // Default display style (usually block or flex)
            } else {
                card.style.display = "none";
            }
        });
    }

    // Initialize default view
    switchView('dashboard');
</script>

</body>
</html>
