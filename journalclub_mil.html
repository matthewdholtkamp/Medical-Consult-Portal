<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operational Medical Journal Club - Dr. Holtkamp Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom Theme Overrides */
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --accent: #e94560;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .glass-panel {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Markdown Styles */
        .prose-invert h1, .prose-invert h2, .prose-invert h3 {
            color: #F39C12;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 700;
        }
        .prose-invert h2 { border-bottom: 1px solid #333; padding-bottom: 5px; }
        .prose-invert strong { color: var(--accent); }
        .prose-invert ul { list-style-type: disc; padding-left: 20px; margin: 10px 0; }
        .prose-invert li { margin-bottom: 5px; }
        .prose-invert p { margin-bottom: 1em; line-height: 1.7; }
        .prose-invert a { color: #38bdf8; text-decoration: underline; }
        
        /* Loading Animation */
        .pulse-ring {
            display: inline-block;
            width: 64px;
            height: 64px;
        }
        .pulse-ring:after {
            content: " ";
            display: block;
            width: 46px;
            height: 46px;
            margin: 1px;
            border-radius: 50%;
            border: 5px solid var(--accent);
            border-color: var(--accent) transparent var(--accent) transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            border: 1px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <div id="toast">Notification Message</div>

    <header class="w-full max-w-4xl text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-extrabold text-orange-500 tracking-tight mb-3">Operational Medicine Journal Club</h1>
        <p class="text-blue-50 mt-2 text-2xl font-semibold leading-relaxed">JTS CPGs, Deployed Medicine, and Tactical Evidence</p>
        <p class="text-gray-500 text-sm mt-3 italic">Deployment Readiness Starts Now - Brought to you by Dr. Matthew Holtkamp</p>
    </header>

    <main class="w-full max-w-4xl">
        
        <div class="bg-blue-900/30 border border-blue-800 rounded-lg p-4 mb-8 text-center text-xs text-blue-200">
            <strong>Operational Use Only.</strong> Verify with current JTS Clinical Practice Guidelines (CPGs) and Theater Medical Directors.
        </div>

        <div id="step1" class="glass-panel rounded-xl p-6 shadow-2xl mb-6">
            <form id="queryForm" class="space-y-4">
                <div>
                    <label class="block text-lg font-semibold mb-2">Operational Topic or Clinical Question</label>
                    <input type="text" id="initialQuestion" 
                           class="w-full bg-slate-800 border border-slate-600 rounded-lg p-4 text-white focus:ring-2 focus:ring-orange-500 outline-none transition"
                           placeholder="e.g., Fresh Whole Blood transfusion in Prolonged Field Care" required>
                </div>
                <button type="submit" id="btnRefine"
                        class="w-full bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex justify-center items-center gap-2">
                    <span>Initialize Refinement</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </form>
        </div>

        <div id="step2" class="glass-panel rounded-xl p-6 shadow-2xl mb-6 hidden">
            <h3 class="text-xl font-bold text-orange-400 mb-4 border-b border-gray-700 pb-2">Refining Operational Context</h3>
            <form id="refinementForm" class="space-y-4">
                <div id="dynamicInputs" class="space-y-4"></div>
                <div class="flex gap-4 pt-2">
                    <button type="button" id="btnBackToStep1" class="w-1/3 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg">Back</button>
                    <button type="submit" id="btnGenerate" class="w-2/3 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-[1.01]">Generate Analysis</button>
                </div>
            </form>
        </div>

        <div id="loader" class="hidden text-center py-12">
            <div class="pulse-ring"></div>
            <p id="loaderText" class="mt-4 text-orange-400 font-mono text-sm animate-pulse">Analyzing JTS CPGs & Doctrine...</p>
        </div>

        <div id="results" class="hidden">
            
            <div class="grid grid-cols-2 md:grid-cols-8 gap-2 mb-6 bg-slate-800/50 p-3 rounded-lg border border-slate-700 items-stretch">
                <button id="btnAudio" type="button" class="col-span-2 md:col-span-4 bg-teal-700 hover:bg-teal-600 text-white px-4 py-3 rounded-lg font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all h-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    Listen to Brief
                </button>
                <button id="btnNewTopic" type="button" class="md:col-span-1 bg-red-900/40 hover:bg-red-900/60 text-red-200 px-2 py-3 rounded-lg font-semibold text-xs md:text-sm border border-red-900/50 flex items-center justify-center h-full">New Topic</button>
                <button id="btnBackToRefine" type="button" class="md:col-span-1 bg-slate-700 hover:bg-slate-600 text-gray-200 px-2 py-3 rounded-lg font-medium text-xs md:text-sm flex items-center justify-center h-full">Back</button>
                <button id="btnCopy" type="button" class="md:col-span-1 bg-slate-700 hover:bg-slate-600 text-gray-200 px-2 py-3 rounded-lg font-medium text-xs md:text-sm flex items-center justify-center h-full">Copy Text</button>
                <button id="btnPlan" type="button" class="md:col-span-1 bg-slate-700 hover:bg-slate-600 text-gray-200 px-2 py-3 rounded-lg font-medium text-xs md:text-sm flex items-center justify-center h-full">Copy Plan</button>
            </div>
            
            <div id="audioContainer" class="hidden mb-6 p-4 bg-teal-900/30 border border-teal-800 rounded-lg transition-all duration-300">
                <p class="text-teal-200 text-sm mb-2 font-semibold">üéôÔ∏è Dr. Holtkamp's Operational Analysis</p>
                <div id="audioProgressContainer" class="w-full bg-gray-700 rounded-full h-2.5 mb-3 hidden">
                    <div id="audioProgressBar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    <p id="audioProgressText" class="text-xs text-teal-400 text-center mt-1">Generating Briefing...</p>
                </div>
                <audio id="audioPlayer" controls class="w-full hidden"></audio>
            </div>

            <div id="thinkingContainer" class="hidden mb-6">
                <details class="group bg-slate-900/40 rounded-xl border border-slate-700/30 overflow-hidden">
                    <summary class="list-none p-3 cursor-pointer flex items-center justify-between text-[10px] text-slate-500 font-bold uppercase tracking-widest hover:bg-slate-800/50 transition-colors">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-blue-500/50">üß†</span>
                            <span>View Tactical Reasoning</span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="px-4 pb-4 text-xs text-slate-500 italic font-mono leading-relaxed bg-black/10">
                        <div id="thinkingContent" class="pt-2 whitespace-pre-line"></div>
                    </div>
                </details>
            </div>

            <div class="mb-8 p-6 bg-slate-800/30 rounded-lg border border-slate-700">
                <h3 class="text-lg font-bold text-white mb-2">Interactive Discussion</h3>
                <form id="followUpForm" class="flex gap-2">
                    <input type="text" id="followUpInput" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-orange-500 outline-none" placeholder="Ask Dr. Holtkamp a follow-up about regulations or protocol...">
                    <button type="submit" class="bg-orange-600 hover:bg-orange-500 text-white px-6 rounded-lg font-bold">Ask</button>
                </form>
                <div id="followUpResult" class="mt-4 p-4 bg-slate-800/50 rounded-lg border-l-4 border-orange-500 hidden prose prose-invert max-w-none"></div>
            </div>

            <div class="mb-4 border-b border-gray-700 flex gap-6 overflow-x-auto">
                <button class="tab-btn active text-orange-500 border-b-2 border-orange-500 pb-2 px-1 font-bold" data-target="summary">Guideline Review</button>
                <button class="tab-btn text-gray-400 hover:text-white pb-2 px-1 font-medium" data-target="plan">Operational Plan</button>
                <button class="tab-btn text-gray-400 hover:text-white pb-2 px-1 font-medium" data-target="refs">References</button>
            </div>

            <div id="summaryContent" class="tab-content prose prose-invert max-w-none text-gray-300"></div>
            <div id="planContent" class="tab-content hidden prose prose-invert max-w-none text-gray-300"></div>
            <div id="refsContent" class="tab-content hidden font-mono text-sm bg-black/30 p-4 rounded text-gray-400 whitespace-pre-wrap"></div>

            <div class="mt-8 flex justify-center">
                <button id="btnBackToRefineBottom" class="text-slate-500 hover:text-white underline text-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Back to Refinement
                </button>
            </div>
        </div>
    </main>

    <script>
    !function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.pcmToWav=t():e.pcmToWav=t()}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){var n,o,a,i,f,c,u,d=new DataView(new ArrayBuffer(44+e.length*t*2));return d.setUint32(0,1380533830,!1),d.setUint32(4,36+e.length*t*2,!0),d.setUint32(8,1463899717,!1),d.setUint32(12,1718449184,!1),d.setUint16(20,1,!0),n=t,d.setUint16(22,n,!0),o=r,d.setUint32(24,o,!0),a=r*t*2,d.setUint32(28,a,!0),i=2*t,d.setUint16(32,i,!0),f=16,d.setUint16(34,f,!0),d.setUint32(36,1684108385,!1),c=e.length*t*2,d.setUint32(40,c,!0),u=new Uint8Array(d.buffer,44),e.forEach(function(e,t){var r=44+2*t;d.setInt16(r,e,!0)}),new Blob([d.buffer],{type:"audio/wav"})},e.exports=t.default}])});
    </script>

    <script type="module">
        import { setupSharing } from './js/sharing.js';
        import { API_KEYS } from './js/config.js?v=secure';

        // API Configuration
        const apiKey = API_KEYS.JOURNAL_CLUB;
        const jsonBinKey = "$2a$10$J/Gr0x7KT4o8YHMdHtRgV.MokfRSRnPPdXBI5jJidEiqrvJfbH5Py";
        
        // --- 2026 MODEL CONFIGURATION ---
        const MODELS = {
            STEP1: "gemini-2.5-flash-lite", // High RPD for questions
            STEP2: "gemini-3-flash",        // High reasoning for analysis
            STEP2_FAILOVER: "gemini-2.5-flash-lite", // Backup if 3-Flash hits quota
            STEP3: "gemini-2.5-flash-native-audio-dialog" // Unlimited Audio
        };

        const el = id => document.getElementById(id);
        const dynamicInputs = el('dynamicInputs');
        const toast = el('toast');
        let storedSummary = "", storedContext = "";

        // Toast & Utils
        function showToast(message) {
            toast.innerText = message; toast.className = "show";
            setTimeout(() => { toast.className = ""; }, 3000);
        }
        function stripLatex(t) { return t ? t.replace(/\$([^$]+)\$/g, '$1').replace(/\\text\s*\{([^}]+)\}/g, '$1').replace(/\\([a-zA-Z]+)/g, ' $1 ').trim() : ""; }
        function showLoader(t) { el('loaderText').innerText = t; el('loader').classList.remove('hidden'); }
        function hideLoader() { el('loader').classList.add('hidden'); }

        // Robust Fetcher
        async function fetchWithModel(modelId, payload) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (res.status === 429) throw new Error("429");
            if (!res.ok) throw new Error(await res.text());
            return await res.json();
        }

        // STEP 1: Questions via 2.5 Flash Lite
        el('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const topic = el('initialQuestion').value;
            showLoader("Consulting JTS Guidelines (Flash Lite)...");
            el('step1').classList.add('hidden');

            try {
                const data = await fetchWithModel(MODELS.STEP1, {
                    contents: [{ parts: [{ text: `Topic: "${topic}". Generate 5 operational clarifying questions for a deployed medical scope. Output one per line.` }] }]
                });
                const questions = data.candidates[0].content.parts[0].text.split('\n').filter(l => l.trim().length > 5).slice(0, 5);
                dynamicInputs.innerHTML = questions.map((q, i) => `<div><label class="block text-sm text-gray-400 mb-1">${q}</label><input type="text" name="q${i}" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:border-orange-500 outline-none"></div>`).join('');
                hideLoader(); el('step2').classList.remove('hidden');
            } catch (err) { showToast("API Error."); el('step1').classList.remove('hidden'); hideLoader(); }
        });

        // STEP 2: Analysis via Gemini 3 Flash (with Failover)
        el('refinementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const details = Array.from(dynamicInputs.querySelectorAll('input')).map(i => `${i.previousElementSibling.innerText}: ${i.value}`).join('\n');
            const prompt = `Analyze "${el('initialQuestion').value}" with Context: ${details}. Use JTS CPGs. Separators: |||SECTION_PLAN||| and |||SECTION_REFS|||. No LaTeX.`;
            
            showLoader("Synthesizing Doctrine (Gemini 3 Flash)...");
            el('step2').classList.add('hidden');

            try {
                // Try Primary (Gemini 3)
                const res = await fetchWithModel(MODELS.STEP2, {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { thinking_config: { include_thoughts: true } }
                });
                processResponse(res);
            } catch (err) {
                if (err.message === "429") {
                    showLoader("Gemini 3 Quota Hit. Failing over to Lite...");
                    try {
                        const resBackup = await fetchWithModel(MODELS.STEP2_FAILOVER, { contents: [{ parts: [{ text: prompt }] }] });
                        processResponse(resBackup);
                    } catch (e) { showToast("Analysis Failed."); hideLoader(); el('step2').classList.remove('hidden'); }
                } else { showToast("Error."); hideLoader(); el('step2').classList.remove('hidden'); }
            }
        });

        function processResponse(data) {
            const cand = data.candidates[0];
            
            // Thoughts (if available)
            const thought = cand.content.parts.find(p => p.thought);
            if (thought) { el('thinkingContent').innerText = thought.thought; el('thinkingContainer').classList.remove('hidden'); }

            const rawText = cand.content.parts.find(p => p.text).text;
            storedContext = rawText;
            const splits = rawText.split('|||SECTION_PLAN|||');
            storedSummary = stripLatex(splits[0]);
            const remaining = (splits[1] || "").split('|||SECTION_REFS|||');
            
            el('summaryContent').innerHTML = marked.parse(storedSummary);
            el('planContent').innerHTML = marked.parse(stripLatex(remaining[0] || ""));
            el('refsContent').innerText = stripLatex(remaining[1] || "");
            
            hideLoader(); el('results').classList.remove('hidden');
            MathJax.typesetPromise();
        }

        // STEP 3: Audio via Native Audio Dialog
        el('btnAudio').addEventListener('click', async () => {
            const btn = el('btnAudio'); btn.disabled = true;
            el('audioContainer').classList.remove('hidden');
            el('audioProgressContainer').classList.remove('hidden');
            const pBar = el('audioProgressBar');
            const pText = el('audioProgressText');

            try {
                pBar.style.width = '20%';
                pText.innerText = "Scripting Brief...";
                // Use Lite for script to save reasoning quota
                const scriptRes = await fetchWithModel(MODELS.STEP1, { 
                    contents: [{ parts: [{ text: `You are Dr. Matthew Holtkamp. Brief this as a 4-minute military update: ${storedSummary.substring(0, 3000)}` }] }] 
                });
                const script = scriptRes.candidates[0].content.parts[0].text;

                pBar.style.width = '60%';
                pText.innerText = "Synthesizing Native Audio...";
                await new Promise(r => setTimeout(r, 2000));

                const ttsRes = await fetchWithModel(MODELS.STEP3, {
                    contents: [{ parts: [{ text: script }] }],
                    generationConfig: { responseModalities: ["AUDIO"] }
                });

                const audioPart = ttsRes.candidates[0].content.parts.find(p => p.inlineData);
                const bytes = new Uint8Array(atob(audioPart.inlineData.data).split("").map(c => c.charCodeAt(0)));
                el('audioPlayer').src = URL.createObjectURL(pcmToWav(new Int16Array(bytes.buffer), 1, 24000));
                
                pBar.style.width = '100%';
                pText.innerText = "Ready!";
                setTimeout(() => { el('audioProgressContainer').classList.add('hidden'); el('audioPlayer').classList.remove('hidden'); el('audioPlayer').play(); }, 500);
            } catch (err) { showToast("Audio quota reached."); } finally { btn.disabled = false; }
        });

        // Interactive & Utils
        el('followUpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = el('followUpInput');
            const resBox = el('followUpResult');
            resBox.innerHTML = '<span class="animate-pulse">Consulting CPGs...</span>';
            resBox.classList.remove('hidden');
            try {
                const data = await fetchWithModel(MODELS.STEP1, { contents: [{ parts: [{ text: `Context: ${storedContext}\nQuestion: ${input.value}. Answer as Dr. Holtkamp.` }] }] });
                resBox.innerHTML = marked.parse(stripLatex(data.candidates[0].content.parts[0].text));
            } catch (err) { resBox.innerText = "Error."; }
        });

        el('btnNewTopic').onclick = () => location.reload();
        el('btnBackToRefine').onclick = () => { el('results').classList.add('hidden'); el('step2').classList.remove('hidden'); };
        el('btnBackToStep1').onclick = () => { el('step2').classList.add('hidden'); el('step1').classList.remove('hidden'); };
        el('btnCopy').onclick = () => { navigator.clipboard.writeText(storedSummary); showToast("Summary Copied"); };
        el('btnPlan').onclick = () => { navigator.clipboard.writeText(el('planContent').innerText); showToast("Plan Copied"); };

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-orange-500', 'border-orange-500'));
                btn.classList.add('active', 'text-orange-500', 'border-orange-500');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                el(btn.dataset.target + 'Content').classList.remove('hidden');
            };
        });

        setupSharing({
            apiKey: jsonBinKey,
            getState: () => ({ initialQuestion: el('initialQuestion').value, summaryContent: storedSummary, context: storedContext }),
            restoreState: (s) => { el('initialQuestion').value = s.initialQuestion; storedSummary = s.summaryContent; storedContext = s.context; }
        });
    </script>
</body>
</html>
